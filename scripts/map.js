let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,userLocationMarker=null,allEventLocations=[];function getSavedManualLocation(){try{const e=localStorage.getItem("manualLocation");if(e){const t=JSON.parse(e),a=2592e6;if(Date.now()-t.timestamp<a)return t;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(e){console.log("Failed to load saved manual location")}return null}async function getIPLocation(){try{const e=await fetch("https://ipapi.co/json/"),t=await e.json();if(t.latitude&&t.longitude)return{lat:t.latitude,lng:t.longitude,city:t.city,country:t.country_name}}catch(e){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(e,t,a){if(!a||0===a.length)return null;let n=null,o=1/0;return a.forEach((a=>{if(a.location&&2===a.location.length){const[i,l]=a.location,c=calculateDistance(e,t,i,l);c<o&&(o=c,n=a)}})),n}function calculateDistance(e,t,a,n){const o=(a-e)*Math.PI/180,i=(n-t)*Math.PI/180,l=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function createUserLocationIcon(e=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${e?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${e?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function addUserLocationMarker(e,t,a=!0,n=""){userLocationMarker&&map.removeLayer(userLocationMarker);const o=createUserLocationIcon(a);return userLocationMarker=L.marker([e,t],{icon:o}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${a?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                ${a?'<br><small>Tap "Allow" in banner to improve accuracy</small>':""}\n            </div>\n        `).addTo(map),userLocationMarker}function updateUserLocationMarker(e,t,a=!1,n=""){if(userLocationMarker){userLocationMarker.setLatLng([e,t]),userLocationMarker.setIcon(createUserLocationIcon(a));const o=getSavedManualLocation()&&!a;userLocationMarker.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${a?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                ${a?'<br><small>Tap "Allow" in banner to improve accuracy</small>':""}\n                ${o?'<br><button onclick="window.clearManualLocation()" style="font-size: 11px; padding: 2px 6px; margin-top: 4px; cursor: pointer;">Reset Location</button>':""}\n            </div>\n        `)}else addUserLocationMarker(e,t,a,n)}function clearManualLocation(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),userLocationMarker&&(map.removeLayer(userLocationMarker),userLocationMarker=null),userLocation=null,location.reload()}function setOptimalZoom(e,t,a){if(!map||!a||0===a.length)return;const n=findClosestEvent(e,t,a);if(!n||!n.location)return void map.setView([e,t],12);const[o,i]=n.location,l=Math.min(e,o),c=Math.max(e,o),r=Math.min(t,i),s=Math.max(t,i),d=c-l||.01,u=s-r||.01;let m,p,g,v;e>o?(p=c+.05*d,m=l-.2*d):(m=l-.05*d,p=c+.2*d),t<i?(g=r-.05*u,v=s+.2*u):(v=s+.05*u,g=r-.2*u);const h=L.latLngBounds([m,g],[p,v]);map.fitBounds(h,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${n.title}`)}async function initMap(){const e=localStorage.getItem("theme"),t=(e?"dark-mode"===e:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",a=getSavedManualLocation();let n=null;if(a)n={lat:a.lat,lng:a.lng,isManual:!0,displayName:a.displayName},userLocation={lat:a.lat,lng:a.lng},console.log("Using saved manual location:",a.displayName);else{const e=await getIPLocation();e&&(n={lat:e.lat,lng:e.lng,isManual:!1,city:e.city,country:e.country},userLocation={lat:e.lat,lng:e.lng})}const o=n?[n.lat,n.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(o,6),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),n&&(n.isManual?addUserLocationMarker(n.lat,n.lng,!1,n.displayName):addUserLocationMarker(n.lat,n.lng,!0,`${n.city}, ${n.country}`)),map.on("moveend",updateVisibleEvents),a||setTimeout(showLocationBanner,3e3),n&&(n.isManual?console.log(`Map initialized with saved manual location: ${n.displayName}`):console.log(`Map initialized near ${n.city}, ${n.country}`)),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const e=map.getBounds(),t=visibleEvents.size;visibleEvents.clear(),markers.forEach((t=>{if(t&&t._map){const a=t.getLatLng();if(e.contains(a)){const e=t.eventId;e&&visibleEvents.add(e)}}})),visibleEvents.size===t&&Array.from(visibleEvents).every((e=>visibleEvents.has(e)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(e){if(!map)return;const t=e?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(e){const t=e.rrule?new Date(e.rrule.dtstart):new Date(e.start),a=!!e.rrule;return`\n        <div class="popup-content">\n            <h3>${e.title}</h3>\n            <p>${a?"Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString()}</p>\n            ${e.website?`<p><a href="${e.website}" target="_blank">üåê Website</a></p>`:""}\n            ${e.type?`<p>Type: ${e.type.charAt(0).toUpperCase()+e.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(e){if(!map)return;allEventLocations=e.filter((e=>e.location));const t=new Set(e.map((e=>e.id)));markers=markers.filter((e=>!!(e&&e.eventId&&t.has(e.eventId))||(e._map&&e.remove(),markersCache.delete(e.eventId),!1)));const a=new Set(markers.map((e=>e.eventId)));e.forEach((e=>{if(e.location&&!a.has(e.id)){let t=markersCache.get(e.id);t||(t=L.marker(e.location),t.eventId=e.id,t.bindPopup(createMarkerPopup(e)),markersCache.set(e.id,t)),t._map||t.addTo(map),markers.push(t)}})),userLocation&&allEventLocations.length>0&&markers.length===e.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(e){const t=markers.find((t=>t.eventId===e));t&&t._map&&(t.openPopup(),map.getBounds().contains(t.getLatLng())||map.panTo(t.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const e=document.getElementById("location-banner");e&&e.classList.add("show")}function hideLocationBanner(){const e=document.getElementById("location-banner");e&&e.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:a}=e.coords;userLocation={lat:t,lng:a},updateUserLocationMarker(t,a,!1,"Your precise location"),map&&(allEventLocations.length>0?setOptimalZoom(t,a,allEventLocations):map.setView([t,a],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(e=>{console.log("Location access denied or failed:",e.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}async function geocodeLocation(e){try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&limit=1`),a=await t.json();if(a&&a.length>0){const e=a[0];return{lat:parseFloat(e.lat),lng:parseFloat(e.lon),displayName:e.display_name}}return null}catch(e){return console.error("Geocoding failed:",e),null}}function showLocationModal(){const e=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");e&&(e.classList.add("show"),t&&t.focus())}function hideLocationModal(){const e=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");e&&(e.classList.remove("show"),t&&(t.value=""))}async function handleManualLocation(){const e=document.getElementById("manual-location-input"),t=e?.value?.trim();if(!t)return void alert("Please enter a location");const a=document.getElementById("location-submit"),n=a.textContent;a.textContent="Searching...",a.disabled=!0;try{const e=await geocodeLocation(t);e?(userLocation={lat:e.lat,lng:e.lng},updateUserLocationMarker(e.lat,e.lng,!1,e.displayName),map&&(allEventLocations.length>0?setOptimalZoom(e.lat,e.lng,allEventLocations):map.setView([e.lat,e.lng],12)),localStorage.setItem("locationDecision","manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:e.lat,lng:e.lng,displayName:e.displayName,timestamp:Date.now()})),hideLocationModal(),hideLocationBanner(),console.log("Manual location set:",e.displayName)):alert("Location not found. Please try a different search term.")}catch(e){alert("Failed to find location. Please try again."),console.error("Manual location error:",e)}finally{a.textContent=n,a.disabled=!1}}function setupLocationBanner(){const e=document.getElementById("location-allow"),t=document.getElementById("location-manual"),a=document.getElementById("location-dismiss"),n=document.getElementById("location-modal"),o=document.getElementById("location-modal-close"),i=document.getElementById("location-submit"),l=document.getElementById("location-cancel"),c=document.getElementById("manual-location-input");e&&e.addEventListener("click",(()=>{requestUserLocation()})),t&&t.addEventListener("click",(()=>{showLocationModal()})),a&&a.addEventListener("click",(()=>{localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()})),o&&o.addEventListener("click",(()=>{hideLocationModal()})),i&&i.addEventListener("click",(()=>{handleManualLocation()})),l&&l.addEventListener("click",(()=>{hideLocationModal()})),c&&c.addEventListener("keypress",(e=>{"Enter"===e.key&&handleManualLocation()})),n&&n.addEventListener("click",(e=>{e.target===n&&hideLocationModal()}))}window.clearManualLocation=clearManualLocation;export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};