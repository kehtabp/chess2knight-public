let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,userLocationMarker=null,allEventLocations=[],bannerAutoDismissTimer=null;function getSavedManualLocation(){try{const e=localStorage.getItem("manualLocation");if(e){const o=JSON.parse(e),t=2592e6;if(Date.now()-o.timestamp<t)return o;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(e){console.log("Failed to load saved manual location")}return null}async function getIPLocation(){try{const e=await fetch("https://ipapi.co/json/"),o=await e.json();if(o.latitude&&o.longitude)return{lat:o.latitude,lng:o.longitude,city:o.city,country:o.country_name}}catch(e){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(e,o,t){if(!t||0===t.length)return null;let n=null,a=1/0;return t.forEach((t=>{if(t.location&&2===t.location.length){const[i,l]=t.location,s=calculateDistance(e,o,i,l);s<a&&(a=s,n=t)}})),n}function calculateDistance(e,o,t,n){const a=(t-e)*Math.PI/180,i=(n-o)*Math.PI/180,l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(e*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function createUserLocationIcon(e=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${e?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${e?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function addUserLocationMarker(e,o,t=!0,n=""){userLocationMarker&&map.removeLayer(userLocationMarker);const a=createUserLocationIcon(t);return userLocationMarker=L.marker([e,o],{icon:a}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${t?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${t||n?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(map),userLocationMarker}function updateUserLocationMarker(e,o,t=!1,n=""){if(userLocationMarker){userLocationMarker.setLatLng([e,o]),userLocationMarker.setIcon(createUserLocationIcon(t));const a=getSavedManualLocation()&&!t;userLocationMarker.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${t?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${t||n||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `)}else addUserLocationMarker(e,o,t,n)}function clearManualLocation(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),userLocationMarker&&(map.removeLayer(userLocationMarker),userLocationMarker=null),userLocation=null,location.reload()}function requestUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),requestUserLocation()}function showLocationModalFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),showLocationModal()}function clearUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),clearManualLocation()}function setOptimalZoom(e,o,t){if(!map||!t||0===t.length)return;window.setOptimalZoomFromApp=function(e,o=[]){if(!map)return void console.log("No map available for optimal zoom");if(console.log("Checking if zoom adjustment is needed..."),console.log("Using",o.length,"captured visible events"),0===o.length)return void console.log("No visible events were captured - keeping current zoom and location unchanged");console.log("Captured events found - adjusting zoom to preserve them with user location + 20% padding");const t=[];userLocation&&(t.push([userLocation.lat,userLocation.lng]),console.log("Added user location to bounds")),t.push(...o);const n=L.latLngBounds(t);map.fitBounds(n,{padding:[50,50]}),console.log("Zoom set to show",t.length,"points with 20% padding")},window.captureVisibleEvents=function(){if(!map||!markers)return console.log("No map or markers available for capture"),[];const e=[];return markers.forEach((o=>{map.getBounds().contains(o.getLatLng())&&e.push([o.getLatLng().lat,o.getLatLng().lng])})),console.log("Captured",e.length,"visible events before resize"),e};const n=findClosestEvent(e,o,t);if(!n||!n.location)return void map.setView([e,o],12);const[a,i]=n.location,l=Math.min(e,a),s=Math.max(e,a),r=Math.min(o,i),c=Math.max(o,i),u=s-l||.01,m=c-r||.01;let d,p,g,v;e>a?(p=s+.05*u,d=l-.2*u):(d=l-.05*u,p=s+.2*u),o<i?(g=r-.05*m,v=c+.2*m):(v=c+.05*m,g=r-.2*m);const h=L.latLngBounds([d,g],[p,v]);map.fitBounds(h,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${n.title}`)}async function initMap(){const e=localStorage.getItem("theme"),o=(e?"dark-mode"===e:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",t=getSavedManualLocation();let n=null;if(t)n={lat:t.lat,lng:t.lng,isManual:!0,displayName:t.displayName},userLocation={lat:t.lat,lng:t.lng},console.log("Using saved manual location:",t.displayName);else{const e=await getIPLocation();e&&(n={lat:e.lat,lng:e.lng,isManual:!1,city:e.city,country:e.country},userLocation={lat:e.lat,lng:e.lng})}const a=n?[n.lat,n.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(a,6),currentTileLayer=L.tileLayer(o,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),n&&(n.isManual?addUserLocationMarker(n.lat,n.lng,!1,n.displayName):addUserLocationMarker(n.lat,n.lng,!0,`${n.city}, ${n.country}`)),map.on("moveend",updateVisibleEvents),t||setTimeout(showLocationBanner,500),n&&(n.isManual?console.log(`Map initialized with saved manual location: ${n.displayName}`):console.log(`Map initialized near ${n.city}, ${n.country}`)),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const e=map.getBounds(),o=visibleEvents.size;visibleEvents.clear(),markers.forEach((o=>{if(o&&o._map){const t=o.getLatLng();if(e.contains(t)){const e=o.eventId;e&&visibleEvents.add(e)}}})),visibleEvents.size===o&&Array.from(visibleEvents).every((e=>visibleEvents.has(e)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(e){if(!map)return;const o=e?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(o,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(e){const o=e.rrule?new Date(e.rrule.dtstart):new Date(e.start),t=!!e.rrule;return`\n        <div class="popup-content">\n            <h3>${e.title}</h3>\n            <p>${t?"Weekly on "+o.toLocaleDateString("en-US",{weekday:"long"}):o.toLocaleDateString()}</p>\n            ${e.website?`<p><a href="${e.website}" target="_blank">üåê Website</a></p>`:""}\n            ${e.type?`<p>Type: ${e.type.charAt(0).toUpperCase()+e.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(e){if(!map)return;allEventLocations=e.filter((e=>e.location));const o=new Set(e.map((e=>e.id)));markers=markers.filter((e=>!!(e&&e.eventId&&o.has(e.eventId))||(e._map&&e.remove(),markersCache.delete(e.eventId),!1)));const t=new Set(markers.map((e=>e.eventId)));e.forEach((e=>{if(e.location&&!t.has(e.id)){let o=markersCache.get(e.id);o||(o=L.marker(e.location),o.eventId=e.id,o.bindPopup(createMarkerPopup(e)),markersCache.set(e.id,o)),o._map||o.addTo(map),markers.push(o)}})),userLocation&&allEventLocations.length>0&&markers.length===e.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(e){const o=markers.find((o=>o.eventId===e));o&&o._map&&(o.openPopup(),map.getBounds().contains(o.getLatLng())||map.panTo(o.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const e=document.getElementById("location-banner"),o=document.getElementById("location-banner-progress");e&&(e.classList.add("show"),bannerAutoDismissTimer&&clearTimeout(bannerAutoDismissTimer),o&&(o.style.transform="scaleX(1)",o.style.transition="transform 10s linear",setTimeout((()=>{o.style.transform="scaleX(0)"}),50)),bannerAutoDismissTimer=setTimeout((()=>{hideLocationBanner(),bannerAutoDismissTimer=null}),1e4))}function hideLocationBanner(){const e=document.getElementById("location-banner");e&&e.classList.remove("show")}function requestUserLocation(e=0){navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{const{latitude:o,longitude:t}=e.coords;userLocation={lat:o,lng:t},updateUserLocationMarker(o,t,!1,"Your precise location"),map&&(allEventLocations.length>0?setOptimalZoom(o,t,allEventLocations):map.setView([o,t],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(o=>{console.log("Location request failed:",o.message,"Code:",o.code),1===o.code?(console.log("Location permission denied by user - resetting preference"),localStorage.removeItem("locationDecision"),hideLocationBanner()):(2===o.code||3===o.code)&&e<2?(console.log(`Location API issue (${2===o.code?"unavailable":"timeout"}), retrying... (attempt ${e+1}/3)`),setTimeout((()=>{requestUserLocation(e+1)}),1e3*(e+1))):(console.log("Location request failed after retries or unknown error"),localStorage.setItem("locationDecision","denied"),hideLocationBanner())}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}async function geocodeLocation(e){try{const o=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&limit=1`),t=await o.json();if(t&&t.length>0){const e=t[0];return{lat:parseFloat(e.lat),lng:parseFloat(e.lon),displayName:e.display_name}}return null}catch(e){return console.error("Geocoding failed:",e),null}}function showLocationModal(){const e=document.getElementById("location-modal"),o=document.getElementById("manual-location-input");e&&(e.classList.add("show"),o&&o.focus())}function hideLocationModal(){const e=document.getElementById("location-modal"),o=document.getElementById("manual-location-input");e&&(e.classList.remove("show"),o&&(o.value=""))}async function handleManualLocation(){const e=document.getElementById("manual-location-input"),o=e?.value?.trim();if(!o)return void alert("Please enter a location");const t=document.getElementById("location-submit"),n=t.textContent;t.textContent="Searching...",t.disabled=!0;try{const e=await geocodeLocation(o);e?(userLocation={lat:e.lat,lng:e.lng},updateUserLocationMarker(e.lat,e.lng,!1,e.displayName),map&&(allEventLocations.length>0?setOptimalZoom(e.lat,e.lng,allEventLocations):map.setView([e.lat,e.lng],12)),localStorage.setItem("locationDecision","manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:e.lat,lng:e.lng,displayName:e.displayName,timestamp:Date.now()})),hideLocationModal(),hideLocationBanner(),console.log("Manual location set:",e.displayName)):alert("Location not found. Please try a different search term.")}catch(e){alert("Failed to find location. Please try again."),console.error("Manual location error:",e)}finally{t.textContent=n,t.disabled=!1}}function setupLocationBanner(){const e=document.getElementById("location-allow"),o=document.getElementById("location-manual"),t=document.getElementById("location-dismiss"),n=document.getElementById("location-modal"),a=document.getElementById("location-modal-close"),i=document.getElementById("location-submit"),l=document.getElementById("location-cancel"),s=document.getElementById("manual-location-input");e&&e.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const e=document.getElementById("location-banner-progress");e&&(e.style.transition="none",e.style.transform="scaleX(0)"),requestUserLocation()})),o&&o.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const e=document.getElementById("location-banner-progress");e&&(e.style.transition="none",e.style.transform="scaleX(0)"),showLocationModal()})),t&&t.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const e=document.getElementById("location-banner-progress");e&&(e.style.transition="none",e.style.transform="scaleX(0)"),localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()})),a&&a.addEventListener("click",(()=>{hideLocationModal()})),i&&i.addEventListener("click",(()=>{handleManualLocation()})),l&&l.addEventListener("click",(()=>{hideLocationModal()})),s&&s.addEventListener("keypress",(e=>{"Enter"===e.key&&handleManualLocation()})),n&&n.addEventListener("click",(e=>{e.target===n&&hideLocationModal()}))}window.clearManualLocation=clearManualLocation,window.requestUserLocationFromPopup=requestUserLocationFromPopup,window.showLocationModalFromPopup=showLocationModalFromPopup,window.clearUserLocationFromPopup=clearUserLocationFromPopup;export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};