let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,userLocationMarker=null,allEventLocations=[],bannerAutoDismissTimer=null;function getSavedManualLocation(){try{const o=localStorage.getItem("manualLocation");if(o){const e=JSON.parse(o),t=2592e6;if(Date.now()-e.timestamp<t)return e;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(o){console.log("Failed to load saved manual location")}return null}async function getIPLocation(){try{const o=await fetch("https://ipapi.co/json/"),e=await o.json();if(e.latitude&&e.longitude)return{lat:e.latitude,lng:e.longitude,city:e.city,country:e.country_name}}catch(o){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(o,e,t){if(!t||0===t.length)return null;let n=null,a=1/0;return t.forEach((t=>{if(t.location&&2===t.location.length){const[i,l]=t.location,s=calculateDistance(o,e,i,l);s<a&&(a=s,n=t)}})),n}function calculateDistance(o,e,t,n){const a=(t-o)*Math.PI/180,i=(n-e)*Math.PI/180,l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(o*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function createUserLocationIcon(o=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${o?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${o?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function addUserLocationMarker(o,e,t=!0,n=""){userLocationMarker&&map.removeLayer(userLocationMarker);const a=createUserLocationIcon(t);return userLocationMarker=L.marker([o,e],{icon:a}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${t?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${t||n?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(map),userLocationMarker}function updateUserLocationMarker(o,e,t=!1,n=""){if(userLocationMarker){userLocationMarker.setLatLng([o,e]),userLocationMarker.setIcon(createUserLocationIcon(t));const a=getSavedManualLocation()&&!t;userLocationMarker.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${t?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${t||n||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `)}else addUserLocationMarker(o,e,t,n)}function clearManualLocation(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),userLocationMarker&&(map.removeLayer(userLocationMarker),userLocationMarker=null),userLocation=null,location.reload()}function requestUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),requestUserLocation()}function showLocationModalFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),showLocationModal()}function clearUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),clearManualLocation()}function setOptimalZoom(o,e,t){if(!map||!t||0===t.length)return;window.setOptimalZoomFromApp=function(o,e=[]){if(!map)return void console.log("No map available for optimal zoom");if(console.log("Checking if zoom adjustment is needed..."),console.log("Using",e.length,"captured visible events"),0===e.length)return void console.log("No visible events were captured - keeping current zoom and location unchanged");console.log("Captured events found - adjusting zoom to preserve them with user location + 20% padding");const t=[];userLocation&&(t.push([userLocation.lat,userLocation.lng]),console.log("Added user location to bounds")),t.push(...e);const n=L.latLngBounds(t);map.fitBounds(n,{padding:[50,50]}),console.log("Zoom set to show",t.length,"points with 20% padding")},window.captureVisibleEvents=function(){if(!map||!markers)return console.log("No map or markers available for capture"),[];const o=[];return markers.forEach((e=>{map.getBounds().contains(e.getLatLng())&&o.push([e.getLatLng().lat,e.getLatLng().lng])})),console.log("Captured",o.length,"visible events before resize"),o};const n=findClosestEvent(o,e,t);if(!n||!n.location)return void map.setView([o,e],12);const[a,i]=n.location,l=Math.min(o,a),s=Math.max(o,a),r=Math.min(e,i),c=Math.max(e,i),u=s-l||.01,m=c-r||.01;let d,p,g,v;o>a?(p=s+.05*u,d=l-.2*u):(d=l-.05*u,p=s+.2*u),e<i?(g=r-.05*m,v=c+.2*m):(v=c+.05*m,g=r-.2*m);const h=L.latLngBounds([d,g],[p,v]);map.fitBounds(h,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${n.title}`)}async function initMap(){const o=localStorage.getItem("theme"),e=(o?"dark-mode"===o:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",t=getSavedManualLocation();let n=null;if(t)n={lat:t.lat,lng:t.lng,isManual:!0,displayName:t.displayName},userLocation={lat:t.lat,lng:t.lng},console.log("Using saved manual location:",t.displayName);else{const o=await getIPLocation();o&&(n={lat:o.lat,lng:o.lng,isManual:!1,city:o.city,country:o.country},userLocation={lat:o.lat,lng:o.lng})}const a=n?[n.lat,n.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(a,6),currentTileLayer=L.tileLayer(e,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),n&&(n.isManual?addUserLocationMarker(n.lat,n.lng,!1,n.displayName):addUserLocationMarker(n.lat,n.lng,!0,`${n.city}, ${n.country}`)),map.on("moveend",updateVisibleEvents),t||setTimeout(showLocationBanner,500),n&&(n.isManual?console.log(`Map initialized with saved manual location: ${n.displayName}`):console.log(`Map initialized near ${n.city}, ${n.country}`)),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const o=map.getBounds(),e=visibleEvents.size;visibleEvents.clear(),markers.forEach((e=>{if(e&&e._map){const t=e.getLatLng();if(o.contains(t)){const o=e.eventId;o&&visibleEvents.add(o)}}})),visibleEvents.size===e&&Array.from(visibleEvents).every((o=>visibleEvents.has(o)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(o){if(!map)return;const e=o?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(e,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(o){const e=o.rrule?new Date(o.rrule.dtstart):new Date(o.start),t=!!o.rrule;return`\n        <div class="popup-content">\n            <h3>${o.title}</h3>\n            <p>${t?"Weekly on "+e.toLocaleDateString("en-US",{weekday:"long"}):e.toLocaleDateString()}</p>\n            ${o.website?`<p><a href="${o.website}" target="_blank">üåê Website</a></p>`:""}\n            ${o.type?`<p>Type: ${o.type.charAt(0).toUpperCase()+o.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(o){if(!map)return;allEventLocations=o.filter((o=>o.location));const e=new Set(o.map((o=>o.id)));markers=markers.filter((o=>!!(o&&o.eventId&&e.has(o.eventId))||(o._map&&o.remove(),markersCache.delete(o.eventId),!1)));const t=new Set(markers.map((o=>o.eventId)));o.forEach((o=>{if(o.location&&!t.has(o.id)){let e=markersCache.get(o.id);e||(e=L.marker(o.location),e.eventId=o.id,e.bindPopup(createMarkerPopup(o)),markersCache.set(o.id,e)),e._map||e.addTo(map),markers.push(e)}})),userLocation&&allEventLocations.length>0&&markers.length===o.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(o){const e=markers.find((e=>e.eventId===o));e&&e._map&&(e.openPopup(),map.getBounds().contains(e.getLatLng())||map.panTo(e.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const o=document.getElementById("location-banner"),e=document.getElementById("location-banner-progress");o&&(o.classList.add("show"),bannerAutoDismissTimer&&clearTimeout(bannerAutoDismissTimer),e&&(e.style.transform="scaleX(1)",e.style.transition="transform 10s linear",setTimeout((()=>{e.style.transform="scaleX(0)"}),50)),bannerAutoDismissTimer=setTimeout((()=>{hideLocationBanner(),bannerAutoDismissTimer=null}),1e4))}function hideLocationBanner(){const o=document.getElementById("location-banner");o&&o.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((o=>{const{latitude:e,longitude:t}=o.coords;userLocation={lat:e,lng:t},updateUserLocationMarker(e,t,!1,"Your precise location"),map&&(allEventLocations.length>0?setOptimalZoom(e,t,allEventLocations):map.setView([e,t],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(o=>{console.log("Location access denied or failed:",o.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}async function geocodeLocation(o){try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&limit=1`),t=await e.json();if(t&&t.length>0){const o=t[0];return{lat:parseFloat(o.lat),lng:parseFloat(o.lon),displayName:o.display_name}}return null}catch(o){return console.error("Geocoding failed:",o),null}}function showLocationModal(){const o=document.getElementById("location-modal"),e=document.getElementById("manual-location-input");o&&(o.classList.add("show"),e&&e.focus())}function hideLocationModal(){const o=document.getElementById("location-modal"),e=document.getElementById("manual-location-input");o&&(o.classList.remove("show"),e&&(e.value=""))}async function handleManualLocation(){const o=document.getElementById("manual-location-input"),e=o?.value?.trim();if(!e)return void alert("Please enter a location");const t=document.getElementById("location-submit"),n=t.textContent;t.textContent="Searching...",t.disabled=!0;try{const o=await geocodeLocation(e);o?(userLocation={lat:o.lat,lng:o.lng},updateUserLocationMarker(o.lat,o.lng,!1,o.displayName),map&&(allEventLocations.length>0?setOptimalZoom(o.lat,o.lng,allEventLocations):map.setView([o.lat,o.lng],12)),localStorage.setItem("locationDecision","manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:o.lat,lng:o.lng,displayName:o.displayName,timestamp:Date.now()})),hideLocationModal(),hideLocationBanner(),console.log("Manual location set:",o.displayName)):alert("Location not found. Please try a different search term.")}catch(o){alert("Failed to find location. Please try again."),console.error("Manual location error:",o)}finally{t.textContent=n,t.disabled=!1}}function setupLocationBanner(){const o=document.getElementById("location-allow"),e=document.getElementById("location-manual"),t=document.getElementById("location-dismiss"),n=document.getElementById("location-modal"),a=document.getElementById("location-modal-close"),i=document.getElementById("location-submit"),l=document.getElementById("location-cancel"),s=document.getElementById("manual-location-input");o&&o.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const o=document.getElementById("location-banner-progress");o&&(o.style.transition="none",o.style.transform="scaleX(0)"),requestUserLocation()})),e&&e.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const o=document.getElementById("location-banner-progress");o&&(o.style.transition="none",o.style.transform="scaleX(0)"),showLocationModal()})),t&&t.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const o=document.getElementById("location-banner-progress");o&&(o.style.transition="none",o.style.transform="scaleX(0)"),localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()})),a&&a.addEventListener("click",(()=>{hideLocationModal()})),i&&i.addEventListener("click",(()=>{handleManualLocation()})),l&&l.addEventListener("click",(()=>{hideLocationModal()})),s&&s.addEventListener("keypress",(o=>{"Enter"===o.key&&handleManualLocation()})),n&&n.addEventListener("click",(o=>{o.target===n&&hideLocationModal()}))}window.clearManualLocation=clearManualLocation,window.requestUserLocationFromPopup=requestUserLocationFromPopup,window.showLocationModalFromPopup=showLocationModalFromPopup,window.clearUserLocationFromPopup=clearUserLocationFromPopup;export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};