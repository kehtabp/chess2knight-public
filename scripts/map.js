let map=null,markers=[],currentTileLayer=null,visibleEvents=new Set;function initMap(){const e=localStorage.getItem("theme"),t=(e?"dark-mode"===e:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";return map=L.map("map",{zoomControl:!1}).setView([51.505,-.09],13),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),L.control.zoom({position:"topright"}).addTo(map),map.on("moveend",updateVisibleEvents),map}function updateVisibleEvents(){if(!map)return;const e=map.getBounds();visibleEvents.clear(),markers.forEach((t=>{if(t&&t._map){const a=t.getLatLng();if(e.contains(a)){const e=t.eventId;e&&visibleEvents.add(e)}}})),window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}function updateMapStyle(e){if(!map)return;const t=e?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(e){const t=e.rrule?new Date(e.rrule.dtstart):new Date(e.start),a=!!e.rrule;return`\n        <div class="popup-content">\n            <h3>${e.title}</h3>\n            <p>${a?"Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString()}</p>\n            ${e.website?`<p><a href="${e.website}" target="_blank">üåê Website</a></p>`:""}\n            ${e.type?`<p>Type: ${e.type.charAt(0).toUpperCase()+e.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(e){markers.forEach((e=>{e&&e._map&&e.remove()})),markers=[],e.forEach((e=>{if(e.location){const t=L.marker(e.location);t.eventId=e.id,t.bindPopup(createMarkerPopup(e)),t.addTo(map),markers.push(t)}})),updateVisibleEvents()}function invalidateMapSize(){map&&map.invalidateSize()}function showMarkerPopup(e){const t=markers.find((t=>t.eventId===e));t&&t._map&&(t.openPopup(),map.getBounds().contains(t.getLatLng())||map.panTo(t.getLatLng()))}export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup};