let map=null,markers=[],currentTileLayer=null,visibleEvents=new Set;async function getIPLocation(){try{const e=await fetch("https://ipapi.co/json/"),t=await e.json();if(t.latitude&&t.longitude)return{lat:t.latitude,lng:t.longitude,city:t.city,country:t.country_name}}catch(e){console.log("IP geolocation failed, using default location")}return null}async function initMap(){const e=localStorage.getItem("theme"),t=(e?"dark-mode"===e:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",n=await getIPLocation(),a=n?[n.lat,n.lng]:[51.505,-.09],o=n?10:6;return map=L.map("map",{zoomControl:!1}).setView(a,o),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),map.on("moveend",updateVisibleEvents),setTimeout(showLocationBanner,2e3),n&&console.log(`Map initialized near ${n.city}, ${n.country}`),map}function updateVisibleEvents(){if(!map)return;const e=map.getBounds();visibleEvents.clear(),markers.forEach((t=>{if(t&&t._map){const n=t.getLatLng();if(e.contains(n)){const e=t.eventId;e&&visibleEvents.add(e)}}})),window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}function updateMapStyle(e){if(!map)return;const t=e?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(e){const t=e.rrule?new Date(e.rrule.dtstart):new Date(e.start),n=!!e.rrule;return`\n        <div class="popup-content">\n            <h3>${e.title}</h3>\n            <p>${n?"Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString()}</p>\n            ${e.website?`<p><a href="${e.website}" target="_blank">üåê Website</a></p>`:""}\n            ${e.type?`<p>Type: ${e.type.charAt(0).toUpperCase()+e.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(e){markers.forEach((e=>{e&&e._map&&e.remove()})),markers=[],e.forEach((e=>{if(e.location){const t=L.marker(e.location);t.eventId=e.id,t.bindPopup(createMarkerPopup(e)),t.addTo(map),markers.push(t)}})),updateVisibleEvents()}function invalidateMapSize(){map&&map.invalidateSize()}function showMarkerPopup(e){const t=markers.find((t=>t.eventId===e));t&&t._map&&(t.openPopup(),map.getBounds().contains(t.getLatLng())||map.panTo(t.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const e=document.getElementById("location-banner");e&&e.classList.add("show")}function hideLocationBanner(){const e=document.getElementById("location-banner");e&&e.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:n}=e.coords;map&&(map.setView([t,n],12),console.log("Map centered on user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(e=>{console.log("Location access denied or failed:",e.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}function setupLocationBanner(){const e=document.getElementById("location-allow"),t=document.getElementById("location-dismiss");e&&e.addEventListener("click",(()=>{requestUserLocation()})),t&&t.addEventListener("click",(()=>{localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()}))}export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner};