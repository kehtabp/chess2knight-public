let t=null,n=[],o=new Map,e=null,a=new Set,l=null,i=null,c=null,s=null,r=[];function u(){try{const t=localStorage.getItem("manualLocation");if(t){const n=JSON.parse(t),o=2592e6;if(Date.now()-n.timestamp<o)return n;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(t){}return null}async function d(){try{const t=await fetch("https://ipapi.co/json/"),n=await t.json();if(n.latitude&&n.longitude)return{lat:n.latitude,lng:n.longitude,city:n.city,country:n.country_name}}catch(t){}return null}function m(t,n,o){if(!o||0===o.length)return null;const e=[];return o.forEach((o=>{if(o.location&&2===o.location.length){const[a,l]=o.location,i=p(t,n,a,l);e.push({event:o,distance:i})}})),e.sort(((t,n)=>t.distance-n.distance)),e.length>=3?e[2].event:e.length>0?e[e.length-1].event:null}function g(t,n,o,e=3){if(!o||0===o.length)return[];const a=[];return o.forEach((o=>{if(o.location&&2===o.location.length){const[e,l]=o.location,i=p(t,n,e,l);a.push({event:o,distance:i})}})),a.sort(((t,n)=>t.distance-n.distance)).slice(0,e).map((t=>t.event))}function p(t,n,o,e){const a=(o-t)*Math.PI/180,l=(e-n)*Math.PI/180,i=Math.sin(a/2)*Math.sin(a/2)+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371}function f(t=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${t?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${t?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function w(n,o,e=!0,a=""){s&&t.removeLayer(s);const l=f(e);return s=L.marker([n,o],{icon:l}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${e?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${a?`<br><small>${a}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${e||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(t),s}function h(t,n,o=!1,e=""){if(s){s.setLatLng([t,n]),s.setIcon(f(o));const a=u()&&!o,l=o&&e&&e.includes("accuracy");s.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${o?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${e?`<br><small>${e}</small>`:""}\n                ${l?'<br><small style="color: #ff9500;">‚ö†Ô∏è Location permission will be requested again later for better accuracy</small>':""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${o||e||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `)}else w(t,n,o,e)}function v(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),s&&(t.removeLayer(s),s=null),c=null,location.reload()}function y(){s&&s.closePopup(),J()}function b(){s&&s.closePopup(),Y()}function I(){s&&s.closePopup(),v()}function S(n,o,e){if(!t||!e||0===e.length)return;const a=g(n,o,e,3);if(0===a.length)return void t.setView([n,o],12);const l=L.latLngBounds();l.extend([n,o]),a.forEach((t=>{t.location&&2===t.location.length&&l.extend(t.location)})),t.fitBounds(l,{padding:[80,80],maxZoom:14})}function E(){if(!t||!n)return{events:[],userLocationVisible:!1};const o=[];n.forEach((n=>{t.getBounds().contains(n.getLatLng())&&o.push([n.getLatLng().lat,n.getLatLng().lng])}));let e=!1;return c&&t.getBounds().contains(L.latLng(c.lat,c.lng))&&(e=!0),{events:o,userLocationVisible:e}}function M(n,o={events:[],userLocationVisible:!1}){if(!t)return;Array.isArray(o)&&(o={events:o,userLocationVisible:!1});const e=o.events||[],a=o.userLocationVisible||!1;if(x()&&0===e.length)return;if(0===e.length&&!a)return;const l=t.getBounds();let i=!1;const s=[];for(const t of e)l.contains(L.latLng(t[0],t[1]))||(i=!0,s.push("event"));if(a&&c&&(l.contains(L.latLng(c.lat,c.lng))||(i=!0,s.push("user location"))),!i)return;const r=[...e];if(a&&c&&r.push([c.lat,c.lng]),r.length>0){const n=L.latLngBounds(r);t.fitBounds(n,{padding:[100,100]})}}function B(){if(!t)return;const n=t.getCenter(),o=t.getZoom(),e={lat:n.lat,lng:n.lng,zoom:o,timestamp:Date.now()};localStorage.setItem("mapState",JSON.stringify(e))}function x(){try{const t=localStorage.getItem("mapState");if(!t)return null;const n=JSON.parse(t);if(!n.lat||!n.lng||!n.zoom)return null;const o=Date.now()-2592e6;return n.timestamp&&n.timestamp<o?(localStorage.removeItem("mapState"),null):n}catch(t){return localStorage.removeItem("mapState"),null}}function P(){x()||c&&r&&r.length>0&&S(c.lat,c.lng,r)}async function k(){const n=localStorage.getItem("theme"),o=(n?"dark-mode"===n:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",a=u();let l=null;if(a)l={lat:a.lat,lng:a.lng,isManual:!0,displayName:a.displayName},c={lat:a.lat,lng:a.lng};else{const t=await d();t&&(l={lat:t.lat,lng:t.lng,isManual:!1,city:t.city,country:t.country},c={lat:t.lat,lng:t.lng})}const i=l?[l.lat,l.lng]:[51.505,-.09];t=L.map("map",{zoomControl:!1}).setView(i,6);const s=x();return s&&t.setView([s.lat,s.lng],s.zoom),e=L.tileLayer(o,{attribution:"¬© OpenStreetMap contributors"}).addTo(t),l&&(l.isManual?w(l.lat,l.lng,!1,l.displayName):w(l.lat,l.lng,!0,`${l.city}, ${l.country}`)),t.on("moveend",T),t.on("moveend zoomend",B),a||setTimeout(A,500),l&&l.isManual,Z(),t}function T(){t&&(l&&clearTimeout(l),l=setTimeout((()=>{const o=t.getBounds(),e=a.size;a.clear(),n.forEach((t=>{if(t&&t._map){const n=t.getLatLng();if(o.contains(n)){const n=t.eventId;n&&a.add(n)}}})),a.size===e&&Array.from(a).every((t=>a.has(t)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(a)}}))}),150))}function D(n){if(!t)return;const o=n?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";e&&t.removeLayer(e),e=L.tileLayer(o,{attribution:"¬© OpenStreetMap contributors"}).addTo(t)}function $(t){const n=t.rrule?new Date(t.rrule.dtstart):new Date(t.start),o=!!t.rrule;return`\n        <div class="popup-content">\n            <h3>${t.title}</h3>\n            <p>${o?"Weekly on "+n.toLocaleDateString("en-US",{weekday:"long"}):n.toLocaleDateString()}</p>\n            ${t.website?`<p><a href="${t.website}" target="_blank">üåê Website</a></p>`:""}\n            ${t.type?`<p>Type: ${t.type.charAt(0).toUpperCase()+t.type.slice(1)}</p>`:""}\n        </div>\n    `}function N(e){if(!t)return;r=e.filter((t=>t.location));const a=new Set(e.map((t=>t.id)));n=n.filter((t=>!!(t&&t.eventId&&a.has(t.eventId))||(t._map&&t.remove(),o.delete(t.eventId),!1)));const l=new Set(n.map((t=>t.eventId)));e.forEach((e=>{if(e.location&&!l.has(e.id)){let a=o.get(e.id);a||(a=L.marker(e.location),a.eventId=e.id,a.bindPopup($(e)),o.set(e.id,a)),a._map||a.addTo(t),n.push(a)}})),T()}function U(){if(!t)return;let o=[];if(t.getBounds&&n){const e=t.getBounds();n.forEach((t=>{t&&t.getLatLng&&e.contains(t.getLatLng())&&o.push([t.getLatLng().lat,t.getLatLng().lng])}))}i&&clearTimeout(i),i=setTimeout((()=>{if(t){t.getCenter();const n=t.getZoom();t.invalidateSize({animate:!1,pan:!1}),setTimeout((()=>{if(o.length>0){const e=t.getBounds();if(o.filter((([t,n])=>e.contains(L.latLng(t,n)))).length<o.length){const e=[...o];if(c&&e.push([c.lat,c.lng]),e.length>0){const o=L.latLngBounds(e);t.fitBounds(o,{padding:[80,80],maxZoom:Math.max(n,10)})}}}}),50)}}),100)}function z(o){const e=n.find((t=>t.eventId===o));e&&e._map&&(e.openPopup(),t.getBounds().contains(e.getLatLng())||t.panTo(e.getLatLng()))}async function A(){if(G())return;if(!window.bannerManager)return;const t=await F(),n=`\n        <div class="location-banner-content">\n            <span class="location-icon">üìç</span>\n            <span class="location-text">${t.text}</span>\n            <div class="location-actions">\n                <button class="location-btn location-allow" id="location-allow" \n                        ${t.allowDisabled?"disabled":""} \n                        title="${t.allowTitle}">${t.allowText}</button>\n                <button class="location-btn location-manual" id="location-manual" title="Enter manually">‚úèÔ∏è Manual</button>\n                <button class="location-btn location-dismiss" id="location-dismiss" title="Dismiss">‚úï Skip</button>\n            </div>\n            <div class="location-banner-progress" id="location-banner-progress"></div>\n        </div>\n    `;window.bannerManager.showBanner("location-banner",n,"location-banner",{autoHide:1e4}),V(),setTimeout((()=>{const t=document.getElementById("location-banner-progress");t&&(t.style.transform="scaleX(1)",t.style.transition="transform 10s linear",setTimeout((()=>{t.style.transform="scaleX(0)"}),50))}),100)}function C(){window.bannerManager&&window.bannerManager.hideBanner("location-banner")}async function F(){if(!navigator.permissions)return{text:"Improve location accuracy?",allowText:"‚úì Allow",allowTitle:"Use GPS location",allowDisabled:!1};try{return"denied"===(await navigator.permissions.query({name:"geolocation"})).state?{text:"Location blocked by browser",allowText:"üö´ Denied",allowTitle:"Location access blocked in browser settings. Click the location icon in the address bar to enable.",allowDisabled:!0}:{text:"Improve location accuracy?",allowText:"‚úì Allow",allowTitle:"Use GPS location",allowDisabled:!1}}catch(t){return{text:"Improve location accuracy?",allowText:"‚úì Allow",allowTitle:"Use GPS location",allowDisabled:!1}}}function V(){const t=document.getElementById("location-allow"),n=document.getElementById("location-manual"),o=document.getElementById("location-dismiss");t&&t.addEventListener("click",(n=>{t.disabled||t.classList.contains("disabled")||J()})),n&&n.addEventListener("click",(()=>{Y()})),o&&o.addEventListener("click",(()=>{q("dismissed"),C()}))}function _(t){const{accuracy:n,latitude:o,longitude:e}=t.coords;return!(0===o&&0===e||n>5e3||Math.abs(o)>90||Math.abs(e)>180||n>1e3)}async function O(){if("allowed"===G()&&navigator.permissions)try{"denied"===(await navigator.permissions.query({name:"geolocation"})).state&&(localStorage.removeItem("locationDecision"),setTimeout((()=>{G()||A()}),1e3))}catch(t){}}function q(t){const n={decision:t,timestamp:Date.now()};localStorage.setItem("locationDecision",JSON.stringify(n))}function G(){try{const t=localStorage.getItem("locationDecision");if(!t)return null;try{const n=JSON.parse(t);if(n.decision&&n.timestamp){const t=432e6;return"denied"===n.decision&&Date.now()-n.timestamp>t?(localStorage.removeItem("locationDecision"),null):n.decision}}catch(n){return"denied"===t?(q("denied"),"denied"):t}}catch(t){return localStorage.removeItem("locationDecision"),null}return null}function Z(){window.addEventListener("focus",(()=>{O()})),setInterval((()=>{O()}),6e4),setTimeout((()=>{O()}),2e3)}function J(n=0){navigator.geolocation&&navigator.geolocation.getCurrentPosition((n=>{const{latitude:o,longitude:e,accuracy:a}=n.coords;if(!_(n))return localStorage.removeItem("locationDecision"),C(),c={lat:o,lng:e},h(o,e,!0,`Approximate location (${Math.round(a)}m accuracy)`),t&&(r.length>0?S(o,e,r):t.setView([o,e],12)),void setTimeout((()=>{G()||A()}),3e4);c={lat:o,lng:e},h(o,e,!1,"Your precise location"),t&&(r.length>0?S(o,e,r):t.setView([o,e],12)),q("allowed"),C()}),(t=>{const o="allowed"===G();1===t.code?o?(localStorage.removeItem("locationDecision"),setTimeout((()=>{A()}),2e3)):(localStorage.removeItem("locationDecision"),C()):(2===t.code||3===t.code)&&n<2?setTimeout((()=>{J(n+1)}),1e3*(n+1)):(o?localStorage.removeItem("locationDecision"):q("denied"),C())}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})}async function R(t){try{const n=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1`),o=await n.json();if(o&&o.length>0){const t=o[0];return{lat:parseFloat(t.lat),lng:parseFloat(t.lon),displayName:t.display_name}}return null}catch(t){return null}}function Y(){const t=document.getElementById("location-modal"),n=document.getElementById("manual-location-input");t&&(t.classList.add("show"),n&&n.focus())}function j(){const t=document.getElementById("location-modal"),n=document.getElementById("manual-location-input");t&&(t.classList.remove("show"),n&&(n.value=""))}async function H(){const n=document.getElementById("manual-location-input"),o=n?.value?.trim();if(!o)return void alert("Please enter a location");const e=document.getElementById("location-submit"),a=e.textContent;e.textContent="Searching...",e.disabled=!0;try{const n=await R(o);n?(c={lat:n.lat,lng:n.lng},h(n.lat,n.lng,!1,n.displayName),t&&(r.length>0?S(n.lat,n.lng,r):t.setView([n.lat,n.lng],12)),q("manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:n.lat,lng:n.lng,displayName:n.displayName,timestamp:Date.now()})),j(),C()):alert("Location not found. Please try a different search term.")}catch(t){alert("Failed to find location. Please try again.")}finally{e.textContent=a,e.disabled=!1}}function W(){const t=document.getElementById("location-modal"),n=document.getElementById("location-modal-close"),o=document.getElementById("location-submit"),e=document.getElementById("location-cancel"),a=document.getElementById("manual-location-input");n&&n.addEventListener("click",(()=>{j()})),o&&o.addEventListener("click",(()=>{H()})),e&&e.addEventListener("click",(()=>{j()})),a&&a.addEventListener("keypress",(t=>{"Enter"===t.key&&H()})),t&&t.addEventListener("click",(n=>{n.target===t&&j()}))}function X(){localStorage.removeItem("mapState");let n=c;if(!n){const t=u();t&&(n={lat:t.lat,lng:t.lng})}if(!n)return void J();const o=g(n.lat,n.lng,r,3);if(0===o.length)return void t.setView([n.lat,n.lng],12);const e=L.latLngBounds();e.extend([n.lat,n.lng]),o.forEach((t=>{t.location&&2===t.location.length&&e.extend(t.location)})),t.fitBounds(e,{padding:[80,80],maxZoom:14})}function K(){const t=document.getElementById("my-location-btn");t&&t.addEventListener("click",X)}window.clearManualLocation=v,window.requestUserLocationFromPopup=y,window.showLocationModalFromPopup=b,window.clearUserLocationFromPopup=I,window.setOptimalZoomFromApp=M,window.captureVisibleEvents=E,window.setInitialOptimalZoom=P;export{k as initMap,D as updateMapStyle,N as updateMarkers,U as invalidateMapSize,z as showMarkerPopup,W as setupLocationModal,S as setOptimalZoom,K as setupMyLocationButton};