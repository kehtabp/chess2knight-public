let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,userLocationMarker=null,allEventLocations=[];function getSavedManualLocation(){try{const o=localStorage.getItem("manualLocation");if(o){const t=JSON.parse(o),e=2592e6;if(Date.now()-t.timestamp<e)return t;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(o){console.log("Failed to load saved manual location")}return null}async function getIPLocation(){try{const o=await fetch("https://ipapi.co/json/"),t=await o.json();if(t.latitude&&t.longitude)return{lat:t.latitude,lng:t.longitude,city:t.city,country:t.country_name}}catch(o){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(o,t,e){if(!e||0===e.length)return null;let a=null,n=1/0;return e.forEach((e=>{if(e.location&&2===e.location.length){const[i,l]=e.location,c=calculateDistance(o,t,i,l);c<n&&(n=c,a=e)}})),a}function calculateDistance(o,t,e,a){const n=(e-o)*Math.PI/180,i=(a-t)*Math.PI/180,l=Math.sin(n/2)*Math.sin(n/2)+Math.cos(o*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function createUserLocationIcon(o=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${o?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${o?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function addUserLocationMarker(o,t,e=!0,a=""){userLocationMarker&&map.removeLayer(userLocationMarker);const n=createUserLocationIcon(e);return userLocationMarker=L.marker([o,t],{icon:n}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${e?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${a?`<br><small>${a}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${e||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(map),userLocationMarker}function updateUserLocationMarker(o,t,e=!1,a=""){if(userLocationMarker){userLocationMarker.setLatLng([o,t]),userLocationMarker.setIcon(createUserLocationIcon(e));const n=getSavedManualLocation()&&!e;userLocationMarker.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${e?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${a?`<br><small>${a}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${e||a||n?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `)}else addUserLocationMarker(o,t,e,a)}function clearManualLocation(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),userLocationMarker&&(map.removeLayer(userLocationMarker),userLocationMarker=null),userLocation=null,location.reload()}function requestUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),requestUserLocation()}function showLocationModalFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),showLocationModal()}function clearUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),clearManualLocation()}function setOptimalZoom(o,t,e){if(!map||!e||0===e.length)return;const a=findClosestEvent(o,t,e);if(!a||!a.location)return void map.setView([o,t],12);const[n,i]=a.location,l=Math.min(o,n),c=Math.max(o,n),s=Math.min(t,i),r=Math.max(t,i),u=c-l||.01,d=r-s||.01;let m,p,g,v;o>n?(p=c+.05*u,m=l-.2*u):(m=l-.05*u,p=c+.2*u),t<i?(g=s-.05*d,v=r+.2*d):(v=r+.05*d,g=s-.2*d);const h=L.latLngBounds([m,g],[p,v]);map.fitBounds(h,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${a.title}`)}async function initMap(){const o=localStorage.getItem("theme"),t=(o?"dark-mode"===o:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",e=getSavedManualLocation();let a=null;if(e)a={lat:e.lat,lng:e.lng,isManual:!0,displayName:e.displayName},userLocation={lat:e.lat,lng:e.lng},console.log("Using saved manual location:",e.displayName);else{const o=await getIPLocation();o&&(a={lat:o.lat,lng:o.lng,isManual:!1,city:o.city,country:o.country},userLocation={lat:o.lat,lng:o.lng})}const n=a?[a.lat,a.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(n,6),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),a&&(a.isManual?addUserLocationMarker(a.lat,a.lng,!1,a.displayName):addUserLocationMarker(a.lat,a.lng,!0,`${a.city}, ${a.country}`)),map.on("moveend",updateVisibleEvents),e||setTimeout(showLocationBanner,3e3),a&&(a.isManual?console.log(`Map initialized with saved manual location: ${a.displayName}`):console.log(`Map initialized near ${a.city}, ${a.country}`)),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const o=map.getBounds(),t=visibleEvents.size;visibleEvents.clear(),markers.forEach((t=>{if(t&&t._map){const e=t.getLatLng();if(o.contains(e)){const o=t.eventId;o&&visibleEvents.add(o)}}})),visibleEvents.size===t&&Array.from(visibleEvents).every((o=>visibleEvents.has(o)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(o){if(!map)return;const t=o?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(o){const t=o.rrule?new Date(o.rrule.dtstart):new Date(o.start),e=!!o.rrule;return`\n        <div class="popup-content">\n            <h3>${o.title}</h3>\n            <p>${e?"Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString()}</p>\n            ${o.website?`<p><a href="${o.website}" target="_blank">üåê Website</a></p>`:""}\n            ${o.type?`<p>Type: ${o.type.charAt(0).toUpperCase()+o.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(o){if(!map)return;allEventLocations=o.filter((o=>o.location));const t=new Set(o.map((o=>o.id)));markers=markers.filter((o=>!!(o&&o.eventId&&t.has(o.eventId))||(o._map&&o.remove(),markersCache.delete(o.eventId),!1)));const e=new Set(markers.map((o=>o.eventId)));o.forEach((o=>{if(o.location&&!e.has(o.id)){let t=markersCache.get(o.id);t||(t=L.marker(o.location),t.eventId=o.id,t.bindPopup(createMarkerPopup(o)),markersCache.set(o.id,t)),t._map||t.addTo(map),markers.push(t)}})),userLocation&&allEventLocations.length>0&&markers.length===o.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(o){const t=markers.find((t=>t.eventId===o));t&&t._map&&(t.openPopup(),map.getBounds().contains(t.getLatLng())||map.panTo(t.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const o=document.getElementById("location-banner");o&&o.classList.add("show")}function hideLocationBanner(){const o=document.getElementById("location-banner");o&&o.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((o=>{const{latitude:t,longitude:e}=o.coords;userLocation={lat:t,lng:e},updateUserLocationMarker(t,e,!1,"Your precise location"),map&&(allEventLocations.length>0?setOptimalZoom(t,e,allEventLocations):map.setView([t,e],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(o=>{console.log("Location access denied or failed:",o.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}async function geocodeLocation(o){try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&limit=1`),e=await t.json();if(e&&e.length>0){const o=e[0];return{lat:parseFloat(o.lat),lng:parseFloat(o.lon),displayName:o.display_name}}return null}catch(o){return console.error("Geocoding failed:",o),null}}function showLocationModal(){const o=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");o&&(o.classList.add("show"),t&&t.focus())}function hideLocationModal(){const o=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");o&&(o.classList.remove("show"),t&&(t.value=""))}async function handleManualLocation(){const o=document.getElementById("manual-location-input"),t=o?.value?.trim();if(!t)return void alert("Please enter a location");const e=document.getElementById("location-submit"),a=e.textContent;e.textContent="Searching...",e.disabled=!0;try{const o=await geocodeLocation(t);o?(userLocation={lat:o.lat,lng:o.lng},updateUserLocationMarker(o.lat,o.lng,!1,o.displayName),map&&(allEventLocations.length>0?setOptimalZoom(o.lat,o.lng,allEventLocations):map.setView([o.lat,o.lng],12)),localStorage.setItem("locationDecision","manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:o.lat,lng:o.lng,displayName:o.displayName,timestamp:Date.now()})),hideLocationModal(),hideLocationBanner(),console.log("Manual location set:",o.displayName)):alert("Location not found. Please try a different search term.")}catch(o){alert("Failed to find location. Please try again."),console.error("Manual location error:",o)}finally{e.textContent=a,e.disabled=!1}}function setupLocationBanner(){const o=document.getElementById("location-allow"),t=document.getElementById("location-manual"),e=document.getElementById("location-dismiss"),a=document.getElementById("location-modal"),n=document.getElementById("location-modal-close"),i=document.getElementById("location-submit"),l=document.getElementById("location-cancel"),c=document.getElementById("manual-location-input");o&&o.addEventListener("click",(()=>{requestUserLocation()})),t&&t.addEventListener("click",(()=>{showLocationModal()})),e&&e.addEventListener("click",(()=>{localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()})),n&&n.addEventListener("click",(()=>{hideLocationModal()})),i&&i.addEventListener("click",(()=>{handleManualLocation()})),l&&l.addEventListener("click",(()=>{hideLocationModal()})),c&&c.addEventListener("keypress",(o=>{"Enter"===o.key&&handleManualLocation()})),a&&a.addEventListener("click",(o=>{o.target===a&&hideLocationModal()}))}window.clearManualLocation=clearManualLocation,window.requestUserLocationFromPopup=requestUserLocationFromPopup,window.showLocationModalFromPopup=showLocationModalFromPopup,window.clearUserLocationFromPopup=clearUserLocationFromPopup;export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};