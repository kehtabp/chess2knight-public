let n=null,t=[],e=new Map,o=null,a=null,i=new Set,l=null,s=null,c=null,r=null,d=null,u=[],p=null;function m(){try{const n=localStorage.getItem("manualLocation");if(n){const t=JSON.parse(n),e=2592e6;if(Date.now()-t.timestamp<e)return t;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(n){}return null}async function g(){try{const n=await fetch("https://ipapi.co/json/"),t=await n.json();if(t.latitude&&t.longitude)return{lat:t.latitude,lng:t.longitude,city:t.city,country:t.country_name}}catch(n){}return null}function f(n,t,e){if(!e||0===e.length)return null;const o=[];return e.forEach((e=>{if(e.location&&2===e.location.length){const[a,i]=e.location,l=w(n,t,a,i);o.push({event:e,distance:l})}})),o.sort(((n,t)=>n.distance-t.distance)),o.length>=3?o[2].event:o.length>0?o[o.length-1].event:null}function h(n,t,e,o=3){if(!e||0===e.length)return[];const a=[];return e.forEach((e=>{if(e.location&&2===e.location.length){const[o,i]=e.location,l=w(n,t,o,i);a.push({event:e,distance:l})}})),a.sort(((n,t)=>n.distance-t.distance)).slice(0,o).map((n=>n.event))}function w(n,t,e,o){const a=(e-n)*Math.PI/180,i=(o-t)*Math.PI/180,l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(n*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371}function v(n=!0,t=null){return L.divIcon({html:`\n            <div class="user-location-marker ${n?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function y(t,e,o=!0,a="",i=null){r&&n.removeLayer(r),d&&(n.removeLayer(d),d=null),o&&i&&i>0&&(d=L.circle([t,e],{radius:i,color:"rgba(52, 152, 219, 0.6)",fillColor:"rgba(52, 152, 219, 0.06)",fillOpacity:1,weight:2,dashArray:"8, 8",opacity:.8}).addTo(n));const l=v(o,i);return r=L.marker([t,e],{icon:l}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${o?"📍 Your approximate location":"🎯 Your location"}</strong>\n                ${a?`<br><small>${a}</small>`:""}\n                ${i&&i>0?`<br><small>Accuracy: ±${Math.round(i)}m</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">✓ GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">✏️ Manual</button>\n                    ${o||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">✕ Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(n),r}function b(t,e,o=!1,a="",i=null){if(r){r.setLatLng([t,e]),r.setIcon(v(o,i)),d&&(n.removeLayer(d),d=null),o&&i&&i>0&&(d=L.circle([t,e],{radius:i,color:"rgba(52, 152, 219, 0.6)",fillColor:"rgba(52, 152, 219, 0.06)",fillOpacity:1,weight:2,dashArray:"8, 8",opacity:.8}).addTo(n));const l=m()&&!o,s=o&&a&&a.includes("accuracy");r.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${o?"📍 Your approximate location":"🎯 Your location"}</strong>\n                ${a?`<br><small>${a}</small>`:""}\n                ${i&&i>0?`<br><small>Accuracy: ±${Math.round(i)}m</small>`:""}\n                ${s?'<br><small style="color: #ff9500;">⚠️ Location permission will be requested again later for better accuracy</small>':""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">✓ GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">✏️ Manual</button>\n                    ${o||a||l?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">✕ Remove</button>':""}\n                </div>\n            </div>\n        `)}else y(t,e,o,a,i)}function S(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),r&&(n.removeLayer(r),r=null),d&&(n.removeLayer(d),d=null),c=null,location.reload()}function k(){r&&r.closePopup();const n=K();"denied"!==n&&"dismissed"!==n||localStorage.removeItem("locationDecision"),en()}function C(){r&&r.closePopup(),an()}function $(){r&&r.closePopup(),S()}function I(t,e,o){if(!n||!o||0===o.length)return;const a=h(t,e,o,3);if(0===a.length)return void n.setView([t,e],12);const i=L.latLngBounds();i.extend([t,e]),a.forEach((n=>{n.location&&2===n.location.length&&i.extend(n.location)})),n.fitBounds(i,{padding:[80,80],maxZoom:14})}function E(){if(!n||!t)return{events:[],userLocationVisible:!1,totalEvents:0,currentZoom:null};const e=n.getBounds(),o=n.getZoom(),a=[];let i=0;t.forEach((n=>{n&&n.getLatLng&&(i++,e.contains(n.getLatLng())&&a.push([n.getLatLng().lat,n.getLatLng().lng]))}));let l=!1;return c&&e.contains(L.latLng(c.lat,c.lng))&&(l=!0),{events:a,userLocationVisible:l,totalEvents:i,visibleEventCount:a.length,currentZoom:o,mapBounds:{north:e.getNorth(),south:e.getSouth(),east:e.getEast(),west:e.getWest()}}}function D(t,e={events:[],userLocationVisible:!1}){if(!n)return;Array.isArray(e)&&(e={events:e,userLocationVisible:!1});const o=e.events||[],a=e.userLocationVisible||!1;if(0===o.length&&!a)return;if(M()&&0===o.length&&!a)return;const i=[];if(o.forEach((n=>{i.push(n)})),a&&c&&i.push([c.lat,c.lng]),0===i.length)return;const l=n.getBounds(),s=i.filter((n=>l.contains(L.latLng(n[0],n[1]))));if(s.length===i.length){const t=L.latLngBounds(i),e=n.getZoom(),o=n.getBoundsZoom(t,!1,[80,80]),a=o-e;return void(a>.8?n.fitBounds(t,{padding:[80,80],maxZoom:Math.min(o,16)}):a<-1&&n.fitBounds(t,{padding:[80,80],maxZoom:e}))}i.length,s.length;const r=L.latLngBounds(i);n.fitBounds(r,{padding:[80,80],maxZoom:15}),n.getZoom()}function T(){if(!n)return;const t=n.getCenter(),e=n.getZoom(),o={lat:t.lat,lng:t.lng,zoom:e,timestamp:Date.now()};localStorage.setItem("mapState",JSON.stringify(o))}function M(){try{const n=localStorage.getItem("mapState");if(!n)return null;const t=JSON.parse(n);if(!t.lat||!t.lng||!t.zoom)return null;const e=Date.now()-2592e6;return t.timestamp&&t.timestamp<e?(localStorage.removeItem("mapState"),null):t}catch(n){return localStorage.removeItem("mapState"),null}}function A(){M()||c&&u&&u.length>0&&I(c.lat,c.lng,u)}async function x(){const t=localStorage.getItem("theme"),e=(t?"dark-mode"===t:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",i=m();let l=null;if(i)l={lat:i.lat,lng:i.lng,isManual:!0,displayName:i.displayName},c={lat:i.lat,lng:i.lng};else{const n=await g();n&&(l={lat:n.lat,lng:n.lng,isManual:!1,city:n.city,country:n.country},c={lat:n.lat,lng:n.lng})}const s=l?[l.lat,l.lng]:[51.505,-.09];n=L.map("map",{zoomControl:!1}).setView(s,6);const r=M();if(r&&n.setView([r.lat,r.lng],r.zoom),a=L.tileLayer(e,{attribution:"© OpenStreetMap contributors"}).addTo(n),o=L.markerClusterGroup({disableClusteringAtZoom:15,maxClusterRadius:50,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,iconCreateFunction:function(n){const t=n.getChildCount();let e="chess-cluster-small";return t>=10?e="chess-cluster-large":t>=5&&(e="chess-cluster-medium"),L.divIcon({html:`<div class="chess-cluster-inner"><span>${t}</span></div>`,className:e,iconSize:[32,32],iconAnchor:[16,16]})}}),n.addLayer(o),n.on("popupopen",(function(n){p=n.popup,setTimeout((()=>un()),50)})),n.on("popupclose",(function(n){p=null,pn()})),n.on("move zoom",(function(n){p&&setTimeout((()=>un()),10)})),n.on("moveend zoomend",(function(n){p&&setTimeout((()=>un()),10)})),l&&(l.isManual?y(l.lat,l.lng,!1,l.displayName):y(l.lat,l.lng,!0,`${l.city}, ${l.country}`)),n.on("moveend",P),n.on("moveend zoomend",T),B(),!i){const n=K();"allowed"===n?setTimeout((()=>en()),500):n&&"denied"!==n||setTimeout(G,500)}return l&&l.isManual,Q(),n}function B(){if(!n)return;let t=!1;n.on("dragstart",(()=>{window.isMapExpanded||t||(t=!0,window.toggleMap&&window.toggleMap(),setTimeout((()=>{t=!1}),1e3))})),n.on("movestart",(n=>{n.originalEvent&&!window.isMapExpanded&&(t||(t=!0,window.toggleMap&&window.toggleMap(),setTimeout((()=>{t=!1}),1e3)))}))}function P(){n&&o&&(l&&clearTimeout(l),l=setTimeout((()=>{const t=n.getBounds(),e=i.size;i.clear(),o.eachLayer((function(n){if(n instanceof L.Marker){const e=n.getLatLng();if(t.contains(e)){const t=n.eventId;t&&i.add(t)}}})),o.eachLayer((function(n){if(n instanceof L.MarkerCluster){const e=n.getBounds();t.intersects(e)&&n.getAllChildMarkers().forEach((n=>{const t=n.eventId;t&&i.add(t)}))}})),i.size===e&&Array.from(i).every((n=>i.has(n)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(i)}}))}),150))}function O(t){if(!n)return;const e=t?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";a&&n.removeLayer(a),a=L.tileLayer(e,{attribution:"© OpenStreetMap contributors"}).addTo(n)}function R(n="club"){const t={club:{icon:"♟️",bgColor:"#3498db",textColor:"#ffffff"},tournament:{icon:"👑",bgColor:"#f39c12",textColor:"#ffffff"},workshop:{icon:"📚",bgColor:"#9b59b6",textColor:"#ffffff"},online:{icon:"💻",bgColor:"#9b59b6",textColor:"#ffffff"},casual:{icon:"☕",bgColor:"#27ae60",textColor:"#ffffff"},default:{icon:"♕",bgColor:"#34495e",textColor:"#ffffff"}},e=t[n]||t.default;return L.divIcon({html:`\n            <div class="chess-event-marker" data-event-type="${n}">\n                <div class="chess-marker-inner">\n                    <span class="chess-marker-icon">${e.icon}</span>\n                </div>\n                <div class="chess-marker-shadow"></div>\n            </div>\n        `,className:"chess-event-icon",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})}function N(n){try{const t=new Date(n.start),e=n.end?new Date(n.end):new Date(t.getTime()+72e5),o=n=>n.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""),a=n=>n.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""),i=n=>n.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""),l=o(t),s=o(e),c=(a(t),a(e),i(t)),r=i(e);let d="";n.description&&(d+=n.description+"\\n\\n"),n.website&&(d+=`Website: ${n.website}\\n`),d+=`Event Type: ${n.type||"Chess Event"}`;let u="";n.location&&Array.isArray(n.location)&&(u=`${n.location[0]}, ${n.location[1]}`);const p=encodeURIComponent(d),m=encodeURIComponent(u),g=encodeURIComponent(n.title);return{google:`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${g}&dates=${l}/${s}&details=${p}&location=${m}`,outlook:`https://outlook.live.com/calendar/0/deeplink/compose?subject=${g}&startdt=${t.toISOString()}&enddt=${e.toISOString()}&body=${p}&location=${m}`,office365:`https://outlook.office.com/calendar/0/deeplink/compose?subject=${g}&startdt=${t.toISOString()}&enddt=${e.toISOString()}&body=${p}&location=${m}`,yahoo:`https://calendar.yahoo.com/?v=60&title=${g}&st=${c}&et=${r}&desc=${p}&in_loc=${m}`,ics:U(n,t,e,d,u)}}catch(n){return null}}function U(n,t,e,o,a){try{const i=n=>n.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""),l=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Chess2Knight//Event Calendar//EN","BEGIN:VEVENT",`UID:${n.id}@chess2knight.com`,`DTSTART:${i(t)}`,`DTEND:${i(e)}`,`SUMMARY:${n.title.replace(/,/g,"\\,")}`,`DESCRIPTION:${o.replace(/,/g,"\\,").replace(/\n/g,"\\n")}`,a?`LOCATION:${a.replace(/,/g,"\\,")}`:"",`CREATED:${i(new Date)}`,"END:VEVENT","END:VCALENDAR"].filter((n=>n)).join("\r\n"),s=new Blob([l],{type:"text/calendar;charset=utf-8"});return URL.createObjectURL(s)}catch(n){return null}}function V(n){if(n.start){const t=N(n);t&&(window.eventCalendarLinks[n.id]=t)}const t=n.rrule?new Date(n.rrule.dtstart):new Date(n.start),e=!(!n.recurring&&!n.rrule),o={club:{emoji:"♟️",label:"Chess Club"},tournament:{emoji:"👑",label:"Tournament"},workshop:{emoji:"📚",label:"Workshop"},online:{emoji:"💻",label:"Online Event"},casual:{emoji:"☕",label:"Casual Play"}}[n.type||"club"]||{emoji:"♕",label:"Chess Event"};let a,i=null;if(e&&(i=Z(n)),e)if("Weekly"===n.recurring)a=`Weekly on ${t.toLocaleDateString("en-US",{weekday:"long"})} at ${t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}`;else if("Monthly"===n.recurring){const n=t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});a=`Monthly on the ${t.getDate()}${z(t.getDate())} at ${n}`}else a="Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"});else a=t.toLocaleDateString("en-US",{weekday:"long",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});return`\n        <div class="chess-popup-content">\n            <div class="chess-popup-header">\n                <span class="chess-popup-icon">${o.emoji}</span>\n                <h3>${n.title}</h3>\n            </div>\n            <div class="chess-popup-details">\n                <div class="chess-popup-date">\n                    <span class="detail-icon">⏰</span>\n                    <span><strong>${a}</strong></span>\n                </div>\n                ${i?`\n                <div class="chess-popup-next">\n                    <span class="detail-icon">📅</span>\n                    <span><strong>Next: ${i}</strong></span>\n                </div>`:""}\n                <div class="chess-popup-type">\n                    <span class="detail-icon">🎯</span>\n                    <span>${o.label}</span>\n                </div>\n                ${n.description?`\n                <div class="chess-popup-description">\n                    <span class="detail-icon">📝</span>\n                    <span>${n.description}</span>\n                </div>`:""}\n                ${n.website?`\n                <div class="chess-popup-website">\n                    <a href="${n.website}" target="_blank" class="chess-popup-link">\n                        <span class="detail-icon">🌐</span>\n                        <span>Visit Website</span>\n                        <span class="external-icon">↗</span>\n                    </a>\n                </div>`:""}\n                ${n.location?`\n                <div class="chess-popup-directions">\n                    <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(n.location[0])},${encodeURIComponent(n.location[1])}" target="_blank" class="chess-popup-link">\n                        <span class="detail-icon">🗺️</span>\n                        <span>Get Directions</span>\n                        <span class="external-icon">↗</span>\n                    </a>\n                </div>`:""}\n                ${n.start?`\n                <div class="chess-popup-calendar">\n                    <div class="calendar-dropdown">\n                        <button class="calendar-dropdown-btn chess-popup-link" onclick="toggleCalendarDropdown('${n.id}')">\n                            <span class="detail-icon">📅</span>\n                            <span>Add to Calendar</span>\n                            <span class="dropdown-arrow">▼</span>\n                        </button>\n                        <div class="calendar-dropdown-content" id="calendar-dropdown-${n.id}">\n                            <a onclick="addToCalendar('${n.id}', 'google')" class="calendar-option">\n                                <span class="calendar-icon">📆</span>\n                                <span>Google Calendar</span>\n                            </a>\n                            <a onclick="addToCalendar('${n.id}', 'ics')" class="calendar-option">\n                                <span class="calendar-icon">📱</span>\n                                <span>ics file (iPhone)</span>\n                            </a>\n                            <a onclick="addToCalendar('${n.id}', 'outlook')" class="calendar-option">\n                                <span class="calendar-icon">📧</span>\n                                <span>Outlook.com</span>\n                            </a>\n                            <a onclick="addToCalendar('${n.id}', 'office365')" class="calendar-option">\n                                <span class="calendar-icon">🏢</span>\n                                <span>Office 365</span>\n                            </a>\n                            <a onclick="addToCalendar('${n.id}', 'yahoo')" class="calendar-option">\n                                <span class="calendar-icon">🟣</span>\n                                <span>Yahoo Calendar</span>\n                            </a>\n                        </div>\n                    </div>\n                </div>`:""}\n                <div class="chess-popup-actions">\n                    <button onclick="showReportModal('${n.id}', '${n.title.replace(/'/g,"\\'")}', '${n.type||"event"}')" class="chess-report-btn">\n                        <span class="detail-icon">📋</span>\n                        <span>Report Event</span>\n                    </button>\n                </div>\n            </div>\n        </div>\n    `}function z(n){if(n>=11&&n<=13)return"th";switch(n%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}function Z(n){try{const t=new Date,e=new Date(n.start);if("Weekly"===n.recurring){const n=e.getDay(),o=t.getDay(),a=60*e.getHours()+e.getMinutes(),i=60*t.getHours()+t.getMinutes();let l=n-o;0===l&&i>=a?l=7:l<0&&(l+=7);const s=new Date(t);return s.setDate(t.getDate()+l),s.setHours(e.getHours(),e.getMinutes(),0,0),s.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}if("Monthly"===n.recurring){const n=e.getDate(),o=new Date(t);return o.setDate(n),o.setHours(e.getHours(),e.getMinutes(),0,0),o<=t&&(o.setMonth(o.getMonth()+1),o.getDate()!==n&&o.setDate(0)),o.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}return null}catch(n){return null}}function j(a){if(!n||!o)return;u=a.filter((n=>n.location));const i=new Set(a.map((n=>n.id))),l=[];t=t.filter((n=>!!(n&&n.eventId&&i.has(n.eventId))||(l.push(n),e.delete(n.eventId),!1))),l.length>0&&o.removeLayers(l);const s=new Set(t.map((n=>n.eventId))),c=[];a.forEach((n=>{if(n.location&&!s.has(n.id)){let o=e.get(n.id);if(!o){const t=R(n.type);o=L.marker(n.location,{icon:t}),o.eventId=n.id,o.bindPopup(V(n)),e.set(n.id,o)}c.push(o),t.push(o)}})),c.length>0&&o.addLayers(c),P()}function q(){if(!n)return;let e=[];if(n.getBounds&&t){const o=n.getBounds();t.forEach((n=>{n&&n.getLatLng&&o.contains(n.getLatLng())&&e.push([n.getLatLng().lat,n.getLatLng().lng])}))}s&&clearTimeout(s),s=setTimeout((()=>{if(n){n.getCenter();const t=n.getZoom();n.invalidateSize({animate:!1,pan:!1}),setTimeout((()=>{if(e.length>0){const o=n.getBounds();if(e.filter((([n,t])=>o.contains(L.latLng(n,t)))).length<e.length){const o=[...e];if(c&&o.push([c.lat,c.lng]),o.length>0){const e=L.latLngBounds(o);n.fitBounds(e,{padding:[80,80],maxZoom:Math.max(t,10)})}}}}),50)}}),100)}function F(e){const a=t.find((n=>n.eventId===e));if(a&&o){const t=o.getVisibleParent(a);t&&t instanceof L.MarkerCluster?o.zoomToShowLayer(a,(()=>{a.openPopup()})):(a.openPopup(),n.getBounds().contains(a.getLatLng())||n.panTo(a.getLatLng()))}}async function G(){const n=K();if("allowed"===n||"manual"===n)return;if("dismissed"===n)return;if(!window.bannerManager)return;const t=await W();if(!t)return;const e=`\n        <div class="location-banner-content">\n            <span class="location-icon">📍</span>\n            <span class="location-text">${t.text}</span>\n            <div class="location-actions">\n                <button class="location-btn location-allow" id="location-allow" \n                        ${t.allowDisabled?"disabled":""} \n                        title="${t.allowTitle}">${t.allowText}</button>\n                <button class="location-btn location-manual" id="location-manual" title="Enter manually">✏️ Manual</button>\n                <button class="location-btn location-dismiss" id="location-dismiss" title="Dismiss">✕ Skip</button>\n            </div>\n            <div class="location-banner-progress" id="location-banner-progress"></div>\n        </div>\n    `;window.bannerManager.showBanner("location-banner",e,"location-banner",{autoHide:1e4}),H(),setTimeout((()=>{const n=document.getElementById("location-banner-progress");n&&(n.style.transform="scaleX(1)",n.style.transition="transform 10s linear",setTimeout((()=>{n.style.transform="scaleX(0)"}),50))}),100)}function _(){window.bannerManager&&window.bannerManager.hideBanner("location-banner")}async function W(){if(!navigator.permissions)return{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1};try{switch((await navigator.permissions.query({name:"geolocation"})).state){case"denied":return{text:"Location blocked by browser",allowText:"🚫 Denied",allowTitle:"Location access blocked in browser settings. Click the location icon in the address bar to enable.",allowDisabled:!0};case"granted":return"allowed"===K()?null:{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1};default:return{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1}}}catch(n){return{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1}}}function H(){const n=document.getElementById("location-allow"),t=document.getElementById("location-manual"),e=document.getElementById("location-dismiss");n&&n.addEventListener("click",(t=>{if(n.disabled||n.classList.contains("disabled"))return;const e=K();"denied"!==e&&"dismissed"!==e||localStorage.removeItem("locationDecision"),en()})),t&&t.addEventListener("click",(()=>{an()})),e&&e.addEventListener("click",(()=>{X("dismissed"),_()}))}function Y(n){const{accuracy:t,latitude:e,longitude:o}=n.coords;return!(0===e&&0===o||t>3e3||Math.abs(e)>90||Math.abs(o)>180||!(t<=100||t<=500))}async function J(){if("allowed"===K()&&navigator.permissions)try{"denied"===(await navigator.permissions.query({name:"geolocation"})).state&&await nn()}catch(n){}}function X(n){const t={decision:n,timestamp:Date.now()};localStorage.setItem("locationDecision",JSON.stringify(t)),localStorage.getItem("locationDecision")}function K(){try{const n=localStorage.getItem("locationDecision");if(!n)return null;try{const t=JSON.parse(n);if(t.decision&&t.timestamp){const n=1728e5;return"denied"===t.decision&&Date.now()-t.timestamp>n?(localStorage.removeItem("locationDecision"),null):t.decision}}catch(t){return"denied"===n?(X("denied"),"denied"):n}}catch(n){return localStorage.removeItem("locationDecision"),null}return null}function Q(){window.addEventListener("focus",(()=>{setTimeout((()=>J()),500)}));let n=!document.hidden;document.addEventListener("visibilitychange",(()=>{document.hidden||n||setTimeout((()=>J()),1e3),n=!document.hidden})),setInterval((()=>{J()}),12e4),setTimeout((()=>{J()}),3e3)}async function nn(){localStorage.removeItem("locationDecision");const n=navigator.userAgent.includes("Chrome"),t=navigator.userAgent.includes("Firefox"),e=navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome");let o="Location access is blocked by your browser. To enable location:\n\n";o+=n?'1. Click the 🔒 or 🌐 icon in your address bar\n2. Change Location from "Block" to "Allow"\n3. Refresh the page and try again':t?'1. Click the 🛡️ shield icon in your address bar\n2. Click "Allow Location Access"\n3. Try again':e?'1. Go to Safari > Settings for This Website\n2. Change Location from "Deny" to "Ask" or "Allow"\n3. Refresh the page and try again':"1. Look for a location/site permissions icon in your address bar\n2. Change location access from blocked to allowed\n3. Refresh the page and try again",alert(o),_()}function tn(){if(p&&p.isOpen())return!0;const n=M();if(n){const t=3e5;if(Date.now()-n.timestamp<t)return!0}return!1}async function en(t=0){navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o,accuracy:a}=t.coords;if(!Y(t))return X("allowed"),_(),c={lat:e,lng:o},b(e,o,!0,`Approximate location (${Math.round(a)}m accuracy)`,a),n&&!tn()&&(u.length>0?I(e,o,u):n.setView([e,o],12)),void setTimeout((()=>{en()}),3e4);c={lat:e,lng:o},b(e,o,!1,"Your precise location",a),n&&!tn()&&(u.length>0?I(e,o,u):n.setView([e,o],12)),X("allowed"),_()}),(async n=>{const e="allowed"===K();if(1===n.code)if(e){if(navigator.permissions)try{if("denied"===(await navigator.permissions.query({name:"geolocation"})).state)return void await nn()}catch(n){}localStorage.removeItem("locationDecision"),setTimeout((()=>{G()}),2e3)}else localStorage.removeItem("locationDecision"),_();else(2===n.code||3===n.code)&&t<2?setTimeout((()=>{en(t+1)}),1e3*(t+1)):(e?localStorage.removeItem("locationDecision"):X("denied"),_())}),{enableHighAccuracy:!0,timeout:15e3,maximumAge:6e4})}async function on(n){try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(n)}&limit=1`),e=await t.json();if(e&&e.length>0){const n=e[0];return{lat:parseFloat(n.lat),lng:parseFloat(n.lon),displayName:n.display_name}}return null}catch(n){return null}}function an(){const n=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");n&&(n.classList.add("show"),t&&t.focus())}function ln(){const n=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");n&&(n.classList.remove("show"),t&&(t.value=""))}async function sn(){const t=document.getElementById("manual-location-input"),e=t?.value?.trim();if(!e)return void alert("Please enter a location");const o=document.getElementById("location-submit"),a=o.textContent;o.textContent="Searching...",o.disabled=!0;try{const t=await on(e);t?(c={lat:t.lat,lng:t.lng},b(t.lat,t.lng,!1,t.displayName),n&&!tn()&&(u.length>0?I(t.lat,t.lng,u):n.setView([t.lat,t.lng],12)),X("manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:t.lat,lng:t.lng,displayName:t.displayName,timestamp:Date.now()})),ln(),_()):alert("Location not found. Please try a different search term.")}catch(n){alert("Failed to find location. Please try again.")}finally{o.textContent=a,o.disabled=!1}}function cn(){const n=document.getElementById("location-modal"),t=document.getElementById("location-modal-close"),e=document.getElementById("location-submit"),o=document.getElementById("location-cancel"),a=document.getElementById("manual-location-input");t&&t.addEventListener("click",(()=>{ln()})),e&&e.addEventListener("click",(()=>{sn()})),o&&o.addEventListener("click",(()=>{ln()})),a&&a.addEventListener("keypress",(n=>{"Enter"===n.key&&sn()})),n&&n.addEventListener("click",(t=>{t.target===n&&ln()}))}async function rn(){localStorage.removeItem("mapState");let t=c;if(!t){const n=m();n&&(t={lat:n.lat,lng:n.lng})}if(!t){if(navigator.permissions)try{if("denied"===(await navigator.permissions.query({name:"geolocation"})).state){const n=navigator.userAgent.includes("Chrome"),t=navigator.userAgent.includes("Firefox"),e=navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome");let o="Location access is currently blocked. To use this feature:\n\n";return o+=n?'1. Click the 🔒 or 🌐 icon in your address bar\n2. Change Location from "Block" to "Allow"\n3. Refresh the page and try again':t?'1. Click the 🛡️ shield icon in your address bar\n2. Click "Allow Location Access"\n3. Try the My Location button again':e?'1. Go to Safari > Settings for This Website\n2. Change Location from "Deny" to "Ask" or "Allow"\n3. Refresh the page and try again':"1. Look for a location/site permissions icon in your address bar\n2. Change location access from blocked to allowed\n3. Refresh the page and try again",void alert(o)}}catch(n){}const n=K();return"denied"!==n&&"dismissed"!==n||localStorage.removeItem("locationDecision"),G(),void setTimeout((()=>{en()}),1e3)}const e=h(t.lat,t.lng,u,3);if(0===e.length)return void n.setView([t.lat,t.lng],12);const o=L.latLngBounds();o.extend([t.lat,t.lng]),e.forEach((n=>{n.location&&2===n.location.length&&o.extend(n.location)})),n.fitBounds(o,{padding:[80,80],maxZoom:14})}function dn(){const n=document.getElementById("my-location-btn");n&&n.addEventListener("click",rn)}function un(){if(!p||!p._container)return;const n=p._container.getBoundingClientRect();[{selector:".theme-toggle",name:"theme toggle"},{selector:".map-filters .filter-btn",name:"filter buttons",multiple:!0},{selector:"#my-location-btn",name:"location button"},{selector:".add-event-button",name:"add event button"},{selector:"#toggle-map",name:"map expand button"}].forEach((t=>{(t.multiple?document.querySelectorAll(t.selector):[document.querySelector(t.selector)]).forEach((t=>{if(!t)return;const e=t.getBoundingClientRect();e.right<n.left-10||e.left>n.right+10||e.bottom<n.top-10||e.top>n.bottom+10?t.classList.remove("control-hidden-by-popup"):t.classList.add("control-hidden-by-popup")}))}))}function pn(){document.querySelectorAll(".control-hidden-by-popup").forEach((n=>{n.classList.remove("control-hidden-by-popup")}))}window.clearManualLocation=S,window.requestUserLocationFromPopup=k,window.showLocationModalFromPopup=C,window.clearUserLocationFromPopup=$,window.setOptimalZoomFromApp=D,window.captureVisibleEvents=E,window.setInitialOptimalZoom=A,window.eventCalendarLinks={},window.toggleCalendarDropdown=function(n){const t=document.getElementById(`calendar-dropdown-${n}`);t&&(document.querySelectorAll(".calendar-dropdown-content").forEach((t=>{t.id!==`calendar-dropdown-${n}`&&t.classList.remove("show")})),t.classList.toggle("show"))},window.addToCalendar=function(n,t){const e=window.eventCalendarLinks[n];if(!e)return;const o=document.getElementById(`calendar-dropdown-${n}`);if(o&&o.classList.remove("show"),"ics"===t){const t=document.createElement("a");t.href=e.ics,t.download=`chess-event-${n}.ics`,document.body.appendChild(t),t.click(),document.body.removeChild(t),setTimeout((()=>{URL.revokeObjectURL(e.ics)}),1e3)}else{const n=e[t];n&&window.open(n,"_blank")}},document.addEventListener("click",(function(n){n.target.closest(".calendar-dropdown")||document.querySelectorAll(".calendar-dropdown-content").forEach((n=>{n.classList.remove("show")}))}));export{x as initMap,O as updateMapStyle,j as updateMarkers,q as invalidateMapSize,F as showMarkerPopup,cn as setupLocationModal,I as setOptimalZoom,dn as setupMyLocationButton};