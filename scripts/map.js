let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,allEventLocations=[];async function getIPLocation(){try{const e=await fetch("https://ipapi.co/json/"),t=await e.json();if(t.latitude&&t.longitude)return{lat:t.latitude,lng:t.longitude,city:t.city,country:t.country_name}}catch(e){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(e,t,a){if(!a||0===a.length)return null;let n=null,o=1/0;return a.forEach((a=>{if(a.location&&2===a.location.length){const[i,s]=a.location,l=calculateDistance(e,t,i,s);l<o&&(o=l,n=a)}})),n}function calculateDistance(e,t,a,n){const o=(a-e)*Math.PI/180,i=(n-t)*Math.PI/180,s=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function setOptimalZoom(e,t,a){if(!map||!a||0===a.length)return;const n=findClosestEvent(e,t,a);if(!n||!n.location)return void map.setView([e,t],12);const[o,i]=n.location,s=Math.min(e,o),l=Math.max(e,o),r=Math.min(t,i),c=Math.max(t,i),m=l-s||.01,p=c-r||.01;let u,d,g,h;e>o?(d=l+.05*m,u=s-.2*m):(u=s-.05*m,d=l+.2*m),t<i?(g=r-.05*p,h=c+.2*p):(h=c+.05*p,g=r-.2*p);const v=L.latLngBounds([u,g],[d,h]);map.fitBounds(v,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${n.title}`)}async function initMap(){const e=localStorage.getItem("theme"),t=(e?"dark-mode"===e:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",a=await getIPLocation();a&&(userLocation={lat:a.lat,lng:a.lng});const n=a?[a.lat,a.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(n,6),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),map.on("moveend",updateVisibleEvents),setTimeout(showLocationBanner,2e3),a&&console.log(`Map initialized near ${a.city}, ${a.country}`),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const e=map.getBounds(),t=visibleEvents.size;visibleEvents.clear(),markers.forEach((t=>{if(t&&t._map){const a=t.getLatLng();if(e.contains(a)){const e=t.eventId;e&&visibleEvents.add(e)}}})),visibleEvents.size===t&&Array.from(visibleEvents).every((e=>visibleEvents.has(e)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(e){if(!map)return;const t=e?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(e){const t=e.rrule?new Date(e.rrule.dtstart):new Date(e.start),a=!!e.rrule;return`\n        <div class="popup-content">\n            <h3>${e.title}</h3>\n            <p>${a?"Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString()}</p>\n            ${e.website?`<p><a href="${e.website}" target="_blank">üåê Website</a></p>`:""}\n            ${e.type?`<p>Type: ${e.type.charAt(0).toUpperCase()+e.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(e){if(!map)return;allEventLocations=e.filter((e=>e.location));const t=new Set(e.map((e=>e.id)));markers=markers.filter((e=>!!(e&&e.eventId&&t.has(e.eventId))||(e._map&&e.remove(),markersCache.delete(e.eventId),!1)));const a=new Set(markers.map((e=>e.eventId)));e.forEach((e=>{if(e.location&&!a.has(e.id)){let t=markersCache.get(e.id);t||(t=L.marker(e.location),t.eventId=e.id,t.bindPopup(createMarkerPopup(e)),markersCache.set(e.id,t)),t._map||t.addTo(map),markers.push(t)}})),userLocation&&allEventLocations.length>0&&markers.length===e.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(e){const t=markers.find((t=>t.eventId===e));t&&t._map&&(t.openPopup(),map.getBounds().contains(t.getLatLng())||map.panTo(t.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const e=document.getElementById("location-banner");e&&e.classList.add("show")}function hideLocationBanner(){const e=document.getElementById("location-banner");e&&e.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((e=>{const{latitude:t,longitude:a}=e.coords;userLocation={lat:t,lng:a},map&&(allEventLocations.length>0?setOptimalZoom(t,a,allEventLocations):map.setView([t,a],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(e=>{console.log("Location access denied or failed:",e.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}function setupLocationBanner(){const e=document.getElementById("location-allow"),t=document.getElementById("location-dismiss");e&&e.addEventListener("click",(()=>{requestUserLocation()})),t&&t.addEventListener("click",(()=>{localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()}))}export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};