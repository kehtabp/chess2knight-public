let t=null,n=[],e=new Map,o=null,a=null,l=new Set,i=null,s=null,c=null,r=null,u=[];function d(){try{const t=localStorage.getItem("manualLocation");if(t){const n=JSON.parse(t),e=2592e6;if(Date.now()-n.timestamp<e)return n;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(t){}return null}async function m(){try{const t=await fetch("https://ipapi.co/json/"),n=await t.json();if(n.latitude&&n.longitude)return{lat:n.latitude,lng:n.longitude,city:n.city,country:n.country_name}}catch(t){}return null}function p(t,n,e){if(!e||0===e.length)return null;const o=[];return e.forEach((e=>{if(e.location&&2===e.location.length){const[a,l]=e.location,i=f(t,n,a,l);o.push({event:e,distance:i})}})),o.sort(((t,n)=>t.distance-n.distance)),o.length>=3?o[2].event:o.length>0?o[o.length-1].event:null}function g(t,n,e,o=3){if(!e||0===e.length)return[];const a=[];return e.forEach((e=>{if(e.location&&2===e.location.length){const[o,l]=e.location,i=f(t,n,o,l);a.push({event:e,distance:i})}})),a.sort(((t,n)=>t.distance-n.distance)).slice(0,o).map((t=>t.event))}function f(t,n,e,o){const a=(e-t)*Math.PI/180,l=(o-n)*Math.PI/180,i=Math.sin(a/2)*Math.sin(a/2)+Math.cos(t*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))*6371}function h(t=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${t?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${t?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function v(n,e,o=!0,a=""){r&&t.removeLayer(r);const l=h(o);return r=L.marker([n,e],{icon:l}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${o?"📍 Your approximate location":"🎯 Your location"}</strong>\n                ${a?`<br><small>${a}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">✓ GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">✏️ Manual</button>\n                    ${o||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">✕ Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(t),r}function b(t,n,e=!1,o=""){if(r){r.setLatLng([t,n]),r.setIcon(h(e));const a=d()&&!e,l=e&&o&&o.includes("accuracy");r.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${e?"📍 Your approximate location":"🎯 Your location"}</strong>\n                ${o?`<br><small>${o}</small>`:""}\n                ${l?'<br><small style="color: #ff9500;">⚠️ Location permission will be requested again later for better accuracy</small>':""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">✓ GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">✏️ Manual</button>\n                    ${e||o||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">✕ Remove</button>':""}\n                </div>\n            </div>\n        `)}else v(t,n,e,o)}function w(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),r&&(t.removeLayer(r),r=null),c=null,location.reload()}function y(){r&&r.closePopup(),R()}function I(){r&&r.closePopup(),H()}function S(){r&&r.closePopup(),w()}function k(n,e,o){if(!t||!o||0===o.length)return;const a=g(n,e,o,3);if(0===a.length)return void t.setView([n,e],12);const l=L.latLngBounds();l.extend([n,e]),a.forEach((t=>{t.location&&2===t.location.length&&l.extend(t.location)})),t.fitBounds(l,{padding:[80,80],maxZoom:14})}function E(){if(!t||!n)return{events:[],userLocationVisible:!1};const e=[];n.forEach((n=>{t.getBounds().contains(n.getLatLng())&&e.push([n.getLatLng().lat,n.getLatLng().lng])}));let o=!1;return c&&t.getBounds().contains(L.latLng(c.lat,c.lng))&&(o=!0),{events:e,userLocationVisible:o}}function M(n,e={events:[],userLocationVisible:!1}){if(!t)return;Array.isArray(e)&&(e={events:e,userLocationVisible:!1});const o=e.events||[],a=e.userLocationVisible||!1;if(C()&&0===o.length)return;if(0===o.length&&!a)return;const l=t.getBounds();let i=!1;const s=[];for(const t of o)l.contains(L.latLng(t[0],t[1]))||(i=!0,s.push("event"));if(a&&c&&(l.contains(L.latLng(c.lat,c.lng))||(i=!0,s.push("user location"))),!i)return;const r=[...o];if(a&&c&&r.push([c.lat,c.lng]),r.length>0){const n=L.latLngBounds(r);t.fitBounds(n,{padding:[100,100]})}}function x(){if(!t)return;const n=t.getCenter(),e=t.getZoom(),o={lat:n.lat,lng:n.lng,zoom:e,timestamp:Date.now()};localStorage.setItem("mapState",JSON.stringify(o))}function C(){try{const t=localStorage.getItem("mapState");if(!t)return null;const n=JSON.parse(t);if(!n.lat||!n.lng||!n.zoom)return null;const e=Date.now()-2592e6;return n.timestamp&&n.timestamp<e?(localStorage.removeItem("mapState"),null):n}catch(t){return localStorage.removeItem("mapState"),null}}function B(){C()||c&&u&&u.length>0&&k(c.lat,c.lng,u)}async function P(){const n=localStorage.getItem("theme"),e=(n?"dark-mode"===n:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",l=d();let i=null;if(l)i={lat:l.lat,lng:l.lng,isManual:!0,displayName:l.displayName},c={lat:l.lat,lng:l.lng};else{const t=await m();t&&(i={lat:t.lat,lng:t.lng,isManual:!1,city:t.city,country:t.country},c={lat:t.lat,lng:t.lng})}const s=i?[i.lat,i.lng]:[51.505,-.09];t=L.map("map",{zoomControl:!1}).setView(s,6);const r=C();return r&&t.setView([r.lat,r.lng],r.zoom),a=L.tileLayer(e,{attribution:"© OpenStreetMap contributors"}).addTo(t),o=L.markerClusterGroup({disableClusteringAtZoom:15,maxClusterRadius:50,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,zoomToBoundsOnClick:!0,iconCreateFunction:function(t){const n=t.getChildCount();let e="chess-cluster-small";return n>=10?e="chess-cluster-large":n>=5&&(e="chess-cluster-medium"),L.divIcon({html:`<div class="chess-cluster-inner"><span>${n}</span></div>`,className:e,iconSize:[32,32],iconAnchor:[16,16]})}}),t.addLayer(o),i&&(i.isManual?v(i.lat,i.lng,!1,i.displayName):v(i.lat,i.lng,!0,`${i.city}, ${i.country}`)),t.on("moveend",T),t.on("moveend zoomend",x),l||setTimeout(F,500),i&&i.isManual,J(),t}function T(){t&&o&&(i&&clearTimeout(i),i=setTimeout((()=>{const n=t.getBounds(),e=l.size;l.clear(),o.eachLayer((function(t){if(t instanceof L.Marker){const e=t.getLatLng();if(n.contains(e)){const n=t.eventId;n&&l.add(n)}}})),o.eachLayer((function(t){if(t instanceof L.MarkerCluster){const e=t.getBounds();n.intersects(e)&&t.getAllChildMarkers().forEach((t=>{const n=t.eventId;n&&l.add(n)}))}})),l.size===e&&Array.from(l).every((t=>l.has(t)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(l)}}))}),150))}function D(n){if(!t)return;const e=n?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";a&&t.removeLayer(a),a=L.tileLayer(e,{attribution:"© OpenStreetMap contributors"}).addTo(t)}function $(t="club"){const n={club:{icon:"♟️",bgColor:"#3498db",textColor:"#ffffff"},tournament:{icon:"👑",bgColor:"#f39c12",textColor:"#ffffff"},workshop:{icon:"📚",bgColor:"#9b59b6",textColor:"#ffffff"},online:{icon:"💻",bgColor:"#9b59b6",textColor:"#ffffff"},casual:{icon:"☕",bgColor:"#27ae60",textColor:"#ffffff"},default:{icon:"♕",bgColor:"#34495e",textColor:"#ffffff"}},e=n[t]||n.default;return L.divIcon({html:`\n            <div class="chess-event-marker" data-event-type="${t}">\n                <div class="chess-marker-inner">\n                    <span class="chess-marker-icon">${e.icon}</span>\n                </div>\n                <div class="chess-marker-shadow"></div>\n            </div>\n        `,className:"chess-event-icon",iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})}function z(t){const n=t.rrule?new Date(t.rrule.dtstart):new Date(t.start),e=!!t.rrule,o={club:{emoji:"♟️",label:"Chess Club"},tournament:{emoji:"👑",label:"Tournament"},workshop:{emoji:"📚",label:"Workshop"},online:{emoji:"💻",label:"Online Event"},casual:{emoji:"☕",label:"Casual Play"}}[t.type||"club"]||{emoji:"♕",label:"Chess Event"};return`\n        <div class="chess-popup-content">\n            <div class="chess-popup-header">\n                <span class="chess-popup-icon">${o.emoji}</span>\n                <h3>${t.title}</h3>\n            </div>\n            <div class="chess-popup-details">\n                <div class="chess-popup-date">\n                    <span class="detail-icon">📅</span>\n                    <span>${e?"Weekly on "+n.toLocaleDateString("en-US",{weekday:"long"}):n.toLocaleDateString()}</span>\n                </div>\n                <div class="chess-popup-type">\n                    <span class="detail-icon">🎯</span>\n                    <span>${o.label}</span>\n                </div>\n                ${t.website?`\n                <div class="chess-popup-website">\n                    <a href="${t.website}" target="_blank" class="chess-popup-link">\n                        <span class="detail-icon">🌐</span>\n                        <span>Visit Website</span>\n                        <span class="external-icon">↗</span>\n                    </a>\n                </div>`:""}\n            </div>\n        </div>\n    `}function A(a){if(!t||!o)return;u=a.filter((t=>t.location));const l=new Set(a.map((t=>t.id))),i=[];n=n.filter((t=>!!(t&&t.eventId&&l.has(t.eventId))||(i.push(t),e.delete(t.eventId),!1))),i.length>0&&o.removeLayers(i);const s=new Set(n.map((t=>t.eventId))),c=[];a.forEach((t=>{if(t.location&&!s.has(t.id)){let o=e.get(t.id);if(!o){const n=$(t.type);o=L.marker(t.location,{icon:n}),o.eventId=t.id,o.bindPopup(z(t)),e.set(t.id,o)}c.push(o),n.push(o)}})),c.length>0&&o.addLayers(c),T()}function N(){if(!t)return;let e=[];if(t.getBounds&&n){const o=t.getBounds();n.forEach((t=>{t&&t.getLatLng&&o.contains(t.getLatLng())&&e.push([t.getLatLng().lat,t.getLatLng().lng])}))}s&&clearTimeout(s),s=setTimeout((()=>{if(t){t.getCenter();const n=t.getZoom();t.invalidateSize({animate:!1,pan:!1}),setTimeout((()=>{if(e.length>0){const o=t.getBounds();if(e.filter((([t,n])=>o.contains(L.latLng(t,n)))).length<e.length){const o=[...e];if(c&&o.push([c.lat,c.lng]),o.length>0){const e=L.latLngBounds(o);t.fitBounds(e,{padding:[80,80],maxZoom:Math.max(n,10)})}}}}),50)}}),100)}function V(e){const a=n.find((t=>t.eventId===e));if(a&&o){const n=o.getVisibleParent(a);n&&n instanceof L.MarkerCluster?o.zoomToShowLayer(a,(()=>{a.openPopup()})):(a.openPopup(),t.getBounds().contains(a.getLatLng())||t.panTo(a.getLatLng()))}}async function F(){if(_())return;if(!window.bannerManager)return;const t=await U(),n=`\n        <div class="location-banner-content">\n            <span class="location-icon">📍</span>\n            <span class="location-text">${t.text}</span>\n            <div class="location-actions">\n                <button class="location-btn location-allow" id="location-allow" \n                        ${t.allowDisabled?"disabled":""} \n                        title="${t.allowTitle}">${t.allowText}</button>\n                <button class="location-btn location-manual" id="location-manual" title="Enter manually">✏️ Manual</button>\n                <button class="location-btn location-dismiss" id="location-dismiss" title="Dismiss">✕ Skip</button>\n            </div>\n            <div class="location-banner-progress" id="location-banner-progress"></div>\n        </div>\n    `;window.bannerManager.showBanner("location-banner",n,"location-banner",{autoHide:1e4}),j(),setTimeout((()=>{const t=document.getElementById("location-banner-progress");t&&(t.style.transform="scaleX(1)",t.style.transition="transform 10s linear",setTimeout((()=>{t.style.transform="scaleX(0)"}),50))}),100)}function O(){window.bannerManager&&window.bannerManager.hideBanner("location-banner")}async function U(){if(!navigator.permissions)return{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1};try{return"denied"===(await navigator.permissions.query({name:"geolocation"})).state?{text:"Location blocked by browser",allowText:"🚫 Denied",allowTitle:"Location access blocked in browser settings. Click the location icon in the address bar to enable.",allowDisabled:!0}:{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1}}catch(t){return{text:"Improve location accuracy?",allowText:"✓ Allow",allowTitle:"Use GPS location",allowDisabled:!1}}}function j(){const t=document.getElementById("location-allow"),n=document.getElementById("location-manual"),e=document.getElementById("location-dismiss");t&&t.addEventListener("click",(n=>{t.disabled||t.classList.contains("disabled")||R()})),n&&n.addEventListener("click",(()=>{H()})),e&&e.addEventListener("click",(()=>{G("dismissed"),O()}))}function q(t){const{accuracy:n,latitude:e,longitude:o}=t.coords;return!(0===e&&0===o||n>5e3||Math.abs(e)>90||Math.abs(o)>180||n>1e3)}async function Z(){if("allowed"===_()&&navigator.permissions)try{"denied"===(await navigator.permissions.query({name:"geolocation"})).state&&(localStorage.removeItem("locationDecision"),setTimeout((()=>{_()||F()}),1e3))}catch(t){}}function G(t){const n={decision:t,timestamp:Date.now()};localStorage.setItem("locationDecision",JSON.stringify(n))}function _(){try{const t=localStorage.getItem("locationDecision");if(!t)return null;try{const n=JSON.parse(t);if(n.decision&&n.timestamp){const t=432e6;return"denied"===n.decision&&Date.now()-n.timestamp>t?(localStorage.removeItem("locationDecision"),null):n.decision}}catch(n){return"denied"===t?(G("denied"),"denied"):t}}catch(t){return localStorage.removeItem("locationDecision"),null}return null}function J(){window.addEventListener("focus",(()=>{Z()})),setInterval((()=>{Z()}),6e4),setTimeout((()=>{Z()}),2e3)}function R(n=0){navigator.geolocation&&navigator.geolocation.getCurrentPosition((n=>{const{latitude:e,longitude:o,accuracy:a}=n.coords;if(!q(n))return localStorage.removeItem("locationDecision"),O(),c={lat:e,lng:o},b(e,o,!0,`Approximate location (${Math.round(a)}m accuracy)`),t&&(u.length>0?k(e,o,u):t.setView([e,o],12)),void setTimeout((()=>{_()||F()}),3e4);c={lat:e,lng:o},b(e,o,!1,"Your precise location"),t&&(u.length>0?k(e,o,u):t.setView([e,o],12)),G("allowed"),O()}),(t=>{const e="allowed"===_();1===t.code?e?(localStorage.removeItem("locationDecision"),setTimeout((()=>{F()}),2e3)):(localStorage.removeItem("locationDecision"),O()):(2===t.code||3===t.code)&&n<2?setTimeout((()=>{R(n+1)}),1e3*(n+1)):(e?localStorage.removeItem("locationDecision"):G("denied"),O())}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})}async function Y(t){try{const n=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1`),e=await n.json();if(e&&e.length>0){const t=e[0];return{lat:parseFloat(t.lat),lng:parseFloat(t.lon),displayName:t.display_name}}return null}catch(t){return null}}function H(){const t=document.getElementById("location-modal"),n=document.getElementById("manual-location-input");t&&(t.classList.add("show"),n&&n.focus())}function W(){const t=document.getElementById("location-modal"),n=document.getElementById("manual-location-input");t&&(t.classList.remove("show"),n&&(n.value=""))}async function X(){const n=document.getElementById("manual-location-input"),e=n?.value?.trim();if(!e)return void alert("Please enter a location");const o=document.getElementById("location-submit"),a=o.textContent;o.textContent="Searching...",o.disabled=!0;try{const n=await Y(e);n?(c={lat:n.lat,lng:n.lng},b(n.lat,n.lng,!1,n.displayName),t&&(u.length>0?k(n.lat,n.lng,u):t.setView([n.lat,n.lng],12)),G("manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:n.lat,lng:n.lng,displayName:n.displayName,timestamp:Date.now()})),W(),O()):alert("Location not found. Please try a different search term.")}catch(t){alert("Failed to find location. Please try again.")}finally{o.textContent=a,o.disabled=!1}}function K(){const t=document.getElementById("location-modal"),n=document.getElementById("location-modal-close"),e=document.getElementById("location-submit"),o=document.getElementById("location-cancel"),a=document.getElementById("manual-location-input");n&&n.addEventListener("click",(()=>{W()})),e&&e.addEventListener("click",(()=>{X()})),o&&o.addEventListener("click",(()=>{W()})),a&&a.addEventListener("keypress",(t=>{"Enter"===t.key&&X()})),t&&t.addEventListener("click",(n=>{n.target===t&&W()}))}function Q(){localStorage.removeItem("mapState");let n=c;if(!n){const t=d();t&&(n={lat:t.lat,lng:t.lng})}if(!n)return void R();const e=g(n.lat,n.lng,u,3);if(0===e.length)return void t.setView([n.lat,n.lng],12);const o=L.latLngBounds();o.extend([n.lat,n.lng]),e.forEach((t=>{t.location&&2===t.location.length&&o.extend(t.location)})),t.fitBounds(o,{padding:[80,80],maxZoom:14})}function tt(){const t=document.getElementById("my-location-btn");t&&t.addEventListener("click",Q)}window.clearManualLocation=w,window.requestUserLocationFromPopup=y,window.showLocationModalFromPopup=I,window.clearUserLocationFromPopup=S,window.setOptimalZoomFromApp=M,window.captureVisibleEvents=E,window.setInitialOptimalZoom=B;export{P as initMap,D as updateMapStyle,A as updateMarkers,N as invalidateMapSize,V as showMarkerPopup,K as setupLocationModal,k as setOptimalZoom,tt as setupMyLocationButton};