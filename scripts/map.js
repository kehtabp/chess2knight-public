let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,userLocationMarker=null,allEventLocations=[],bannerAutoDismissTimer=null;function getSavedManualLocation(){try{const t=localStorage.getItem("manualLocation");if(t){const e=JSON.parse(t),o=2592e6;if(Date.now()-e.timestamp<o)return e;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(t){console.log("Failed to load saved manual location")}return null}async function getIPLocation(){try{const t=await fetch("https://ipapi.co/json/"),e=await t.json();if(e.latitude&&e.longitude)return{lat:e.latitude,lng:e.longitude,city:e.city,country:e.country_name}}catch(t){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(t,e,o){if(!o||0===o.length)return null;let n=null,a=1/0;return o.forEach((o=>{if(o.location&&2===o.location.length){const[i,l]=o.location,s=calculateDistance(t,e,i,l);s<a&&(a=s,n=o)}})),n}function calculateDistance(t,e,o,n){const a=(o-t)*Math.PI/180,i=(n-e)*Math.PI/180,l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function createUserLocationIcon(t=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${t?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${t?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function addUserLocationMarker(t,e,o=!0,n=""){userLocationMarker&&map.removeLayer(userLocationMarker);const a=createUserLocationIcon(o);return userLocationMarker=L.marker([t,e],{icon:a}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${o?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${o||n?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(map),userLocationMarker}function updateUserLocationMarker(t,e,o=!1,n=""){if(userLocationMarker){userLocationMarker.setLatLng([t,e]),userLocationMarker.setIcon(createUserLocationIcon(o));const a=getSavedManualLocation()&&!o;userLocationMarker.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${o?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${o||n||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `)}else addUserLocationMarker(t,e,o,n)}function clearManualLocation(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),userLocationMarker&&(map.removeLayer(userLocationMarker),userLocationMarker=null),userLocation=null,location.reload()}function requestUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),requestUserLocation()}function showLocationModalFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),showLocationModal()}function clearUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),clearManualLocation()}function setOptimalZoom(t,e,o){if(!map||!o||0===o.length)return;const n=findClosestEvent(t,e,o);if(!n||!n.location)return void map.setView([t,e],12);const[a,i]=n.location,l=Math.min(t,a),s=Math.max(t,a),r=Math.min(e,i),c=Math.max(e,i),u=s-l||.01,m=c-r||.01;let d,p,g,v;t>a?(p=s+.05*u,d=l-.2*u):(d=l-.05*u,p=s+.2*u),e<i?(g=r-.05*m,v=c+.2*m):(v=c+.05*m,g=r-.2*m);const h=L.latLngBounds([d,g],[p,v]);map.fitBounds(h,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${n.title}`)}async function initMap(){const t=localStorage.getItem("theme"),e=(t?"dark-mode"===t:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",o=getSavedManualLocation();let n=null;if(o)n={lat:o.lat,lng:o.lng,isManual:!0,displayName:o.displayName},userLocation={lat:o.lat,lng:o.lng},console.log("Using saved manual location:",o.displayName);else{const t=await getIPLocation();t&&(n={lat:t.lat,lng:t.lng,isManual:!1,city:t.city,country:t.country},userLocation={lat:t.lat,lng:t.lng})}const a=n?[n.lat,n.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(a,6),currentTileLayer=L.tileLayer(e,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),n&&(n.isManual?addUserLocationMarker(n.lat,n.lng,!1,n.displayName):addUserLocationMarker(n.lat,n.lng,!0,`${n.city}, ${n.country}`)),map.on("moveend",updateVisibleEvents),o||setTimeout(showLocationBanner,500),n&&(n.isManual?console.log(`Map initialized with saved manual location: ${n.displayName}`):console.log(`Map initialized near ${n.city}, ${n.country}`)),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const t=map.getBounds(),e=visibleEvents.size;visibleEvents.clear(),markers.forEach((e=>{if(e&&e._map){const o=e.getLatLng();if(t.contains(o)){const t=e.eventId;t&&visibleEvents.add(t)}}})),visibleEvents.size===e&&Array.from(visibleEvents).every((t=>visibleEvents.has(t)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(t){if(!map)return;const e=t?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(e,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(t){const e=t.rrule?new Date(t.rrule.dtstart):new Date(t.start),o=!!t.rrule;return`\n        <div class="popup-content">\n            <h3>${t.title}</h3>\n            <p>${o?"Weekly on "+e.toLocaleDateString("en-US",{weekday:"long"}):e.toLocaleDateString()}</p>\n            ${t.website?`<p><a href="${t.website}" target="_blank">üåê Website</a></p>`:""}\n            ${t.type?`<p>Type: ${t.type.charAt(0).toUpperCase()+t.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(t){if(!map)return;allEventLocations=t.filter((t=>t.location));const e=new Set(t.map((t=>t.id)));markers=markers.filter((t=>!!(t&&t.eventId&&e.has(t.eventId))||(t._map&&t.remove(),markersCache.delete(t.eventId),!1)));const o=new Set(markers.map((t=>t.eventId)));t.forEach((t=>{if(t.location&&!o.has(t.id)){let e=markersCache.get(t.id);e||(e=L.marker(t.location),e.eventId=t.id,e.bindPopup(createMarkerPopup(t)),markersCache.set(t.id,e)),e._map||e.addTo(map),markers.push(e)}})),userLocation&&allEventLocations.length>0&&markers.length===t.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(t){const e=markers.find((e=>e.eventId===t));e&&e._map&&(e.openPopup(),map.getBounds().contains(e.getLatLng())||map.panTo(e.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const t=document.getElementById("location-banner"),e=document.getElementById("location-banner-progress");t&&(t.classList.add("show"),bannerAutoDismissTimer&&clearTimeout(bannerAutoDismissTimer),e&&(e.style.transform="scaleX(1)",e.style.transition="transform 10s linear",setTimeout((()=>{e.style.transform="scaleX(0)"}),50)),bannerAutoDismissTimer=setTimeout((()=>{hideLocationBanner(),bannerAutoDismissTimer=null}),1e4))}function hideLocationBanner(){const t=document.getElementById("location-banner");t&&t.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords;userLocation={lat:e,lng:o},updateUserLocationMarker(e,o,!1,"Your precise location"),map&&(allEventLocations.length>0?setOptimalZoom(e,o,allEventLocations):map.setView([e,o],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(t=>{console.log("Location access denied or failed:",t.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}async function geocodeLocation(t){try{const e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(t)}&limit=1`),o=await e.json();if(o&&o.length>0){const t=o[0];return{lat:parseFloat(t.lat),lng:parseFloat(t.lon),displayName:t.display_name}}return null}catch(t){return console.error("Geocoding failed:",t),null}}function showLocationModal(){const t=document.getElementById("location-modal"),e=document.getElementById("manual-location-input");t&&(t.classList.add("show"),e&&e.focus())}function hideLocationModal(){const t=document.getElementById("location-modal"),e=document.getElementById("manual-location-input");t&&(t.classList.remove("show"),e&&(e.value=""))}async function handleManualLocation(){const t=document.getElementById("manual-location-input"),e=t?.value?.trim();if(!e)return void alert("Please enter a location");const o=document.getElementById("location-submit"),n=o.textContent;o.textContent="Searching...",o.disabled=!0;try{const t=await geocodeLocation(e);t?(userLocation={lat:t.lat,lng:t.lng},updateUserLocationMarker(t.lat,t.lng,!1,t.displayName),map&&(allEventLocations.length>0?setOptimalZoom(t.lat,t.lng,allEventLocations):map.setView([t.lat,t.lng],12)),localStorage.setItem("locationDecision","manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:t.lat,lng:t.lng,displayName:t.displayName,timestamp:Date.now()})),hideLocationModal(),hideLocationBanner(),console.log("Manual location set:",t.displayName)):alert("Location not found. Please try a different search term.")}catch(t){alert("Failed to find location. Please try again."),console.error("Manual location error:",t)}finally{o.textContent=n,o.disabled=!1}}function setupLocationBanner(){const t=document.getElementById("location-allow"),e=document.getElementById("location-manual"),o=document.getElementById("location-dismiss"),n=document.getElementById("location-modal"),a=document.getElementById("location-modal-close"),i=document.getElementById("location-submit"),l=document.getElementById("location-cancel"),s=document.getElementById("manual-location-input");t&&t.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const t=document.getElementById("location-banner-progress");t&&(t.style.transition="none",t.style.transform="scaleX(0)"),requestUserLocation()})),e&&e.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const t=document.getElementById("location-banner-progress");t&&(t.style.transition="none",t.style.transform="scaleX(0)"),showLocationModal()})),o&&o.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const t=document.getElementById("location-banner-progress");t&&(t.style.transition="none",t.style.transform="scaleX(0)"),localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()})),a&&a.addEventListener("click",(()=>{hideLocationModal()})),i&&i.addEventListener("click",(()=>{handleManualLocation()})),l&&l.addEventListener("click",(()=>{hideLocationModal()})),s&&s.addEventListener("keypress",(t=>{"Enter"===t.key&&handleManualLocation()})),n&&n.addEventListener("click",(t=>{t.target===n&&hideLocationModal()}))}window.clearManualLocation=clearManualLocation,window.requestUserLocationFromPopup=requestUserLocationFromPopup,window.showLocationModalFromPopup=showLocationModalFromPopup,window.clearUserLocationFromPopup=clearUserLocationFromPopup;export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};