let map=null,markers=[],markersCache=new Map,currentTileLayer=null,visibleEvents=new Set,visibleEventsUpdateTimeout=null,mapResizeTimeout=null,userLocation=null,userLocationMarker=null,allEventLocations=[],bannerAutoDismissTimer=null;function getSavedManualLocation(){try{const o=localStorage.getItem("manualLocation");if(o){const t=JSON.parse(o),e=2592e6;if(Date.now()-t.timestamp<e)return t;localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision")}}catch(o){console.log("Failed to load saved manual location")}return null}async function getIPLocation(){try{const o=await fetch("https://ipapi.co/json/"),t=await o.json();if(t.latitude&&t.longitude)return{lat:t.latitude,lng:t.longitude,city:t.city,country:t.country_name}}catch(o){console.log("IP geolocation failed, using default location")}return null}function findClosestEvent(o,t,e){if(!e||0===e.length)return null;let n=null,a=1/0;return e.forEach((e=>{if(e.location&&2===e.location.length){const[i,l]=e.location,s=calculateDistance(o,t,i,l);s<a&&(a=s,n=e)}})),n}function calculateDistance(o,t,e,n){const a=(e-o)*Math.PI/180,i=(n-t)*Math.PI/180,l=Math.sin(a/2)*Math.sin(a/2)+Math.cos(o*Math.PI/180)*Math.cos(e*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))}function createUserLocationIcon(o=!0){return L.divIcon({html:`\n            <div class="user-location-marker ${o?"estimate":"precise"}">\n                <div class="user-location-dot"></div>\n                <div class="user-location-pulse"></div>\n                ${o?'<div class="user-location-estimate-indicator">~</div>':""}\n            </div>\n        `,className:"user-location-icon",iconSize:[24,24],iconAnchor:[12,12]})}function addUserLocationMarker(o,t,e=!0,n=""){userLocationMarker&&map.removeLayer(userLocationMarker);const a=createUserLocationIcon(e);return userLocationMarker=L.marker([o,t],{icon:a}).bindPopup(`\n            <div class="user-location-popup">\n                <strong>${e?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${e||n?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `).addTo(map),userLocationMarker}function updateUserLocationMarker(o,t,e=!1,n=""){if(userLocationMarker){userLocationMarker.setLatLng([o,t]),userLocationMarker.setIcon(createUserLocationIcon(e));const a=getSavedManualLocation()&&!e;userLocationMarker.setPopupContent(`\n            <div class="user-location-popup">\n                <strong>${e?"üìç Your approximate location":"üéØ Your location"}</strong>\n                ${n?`<br><small>${n}</small>`:""}\n                <div class="location-popup-actions">\n                    <button class="location-popup-btn location-allow" onclick="window.requestUserLocationFromPopup()" title="Use GPS location">‚úì GPS</button>\n                    <button class="location-popup-btn location-manual" onclick="window.showLocationModalFromPopup()" title="Enter manually">‚úèÔ∏è Manual</button>\n                    ${e||n||a?'<button class="location-popup-btn location-dismiss" onclick="window.clearUserLocationFromPopup()" title="Remove location">‚úï Remove</button>':""}\n                </div>\n            </div>\n        `)}else addUserLocationMarker(o,t,e,n)}function clearManualLocation(){localStorage.removeItem("manualLocation"),localStorage.removeItem("locationDecision"),userLocationMarker&&(map.removeLayer(userLocationMarker),userLocationMarker=null),userLocation=null,location.reload()}function requestUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),requestUserLocation()}function showLocationModalFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),showLocationModal()}function clearUserLocationFromPopup(){userLocationMarker&&userLocationMarker.closePopup(),clearManualLocation()}function setOptimalZoom(o,t,e){if(!map||!e||0===e.length)return;window.setOptimalZoomFromApp=function(o){if(map&&o&&0!==o.length){if(console.log("Setting optimal zoom with user location + closest event + 20% padding"),userLocation){const t=findClosestEvent(userLocation.lat,userLocation.lng,o);if(t&&t.location){console.log("Found closest event:",t.title);const o=L.latLngBounds([[userLocation.lat,userLocation.lng],t.location]);map.fitBounds(o,{padding:[50,50]}),console.log("Zoom set to show user location + closest event with 20% padding")}else console.log("No closest event found, centering on user location"),map.setView([userLocation.lat,userLocation.lng],12)}else if(console.log("No user location available, using default zoom behavior"),o.length>0){const t=o.filter((o=>o.location&&2===o.location.length)).map((o=>o.location));if(t.length>0){const o=L.latLngBounds(t);map.fitBounds(o,{padding:[50,50]}),console.log("Zoom set to show all events with 20% padding")}}}else console.log("No map or events available for optimal zoom")};const n=findClosestEvent(o,t,e);if(!n||!n.location)return void map.setView([o,t],12);const[a,i]=n.location,l=Math.min(o,a),s=Math.max(o,a),c=Math.min(t,i),r=Math.max(t,i),u=s-l||.01,m=r-c||.01;let d,p,g,v;o>a?(p=s+.05*u,d=l-.2*u):(d=l-.05*u,p=s+.2*u),t<i?(g=c-.05*m,v=r+.2*m):(v=r+.05*m,g=c-.2*m);const h=L.latLngBounds([d,g],[p,v]);map.fitBounds(h,{padding:[20,20],maxZoom:15}),console.log(`Zoomed to show user and closest event: ${n.title}`)}async function initMap(){const o=localStorage.getItem("theme"),t=(o?"dark-mode"===o:window.matchMedia("(prefers-color-scheme: dark)").matches)?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png",e=getSavedManualLocation();let n=null;if(e)n={lat:e.lat,lng:e.lng,isManual:!0,displayName:e.displayName},userLocation={lat:e.lat,lng:e.lng},console.log("Using saved manual location:",e.displayName);else{const o=await getIPLocation();o&&(n={lat:o.lat,lng:o.lng,isManual:!1,city:o.city,country:o.country},userLocation={lat:o.lat,lng:o.lng})}const a=n?[n.lat,n.lng]:[51.505,-.09];return map=L.map("map",{zoomControl:!1}).setView(a,6),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map),n&&(n.isManual?addUserLocationMarker(n.lat,n.lng,!1,n.displayName):addUserLocationMarker(n.lat,n.lng,!0,`${n.city}, ${n.country}`)),map.on("moveend",updateVisibleEvents),e||setTimeout(showLocationBanner,500),n&&(n.isManual?console.log(`Map initialized with saved manual location: ${n.displayName}`):console.log(`Map initialized near ${n.city}, ${n.country}`)),map}function updateVisibleEvents(){map&&(visibleEventsUpdateTimeout&&clearTimeout(visibleEventsUpdateTimeout),visibleEventsUpdateTimeout=setTimeout((()=>{const o=map.getBounds(),t=visibleEvents.size;visibleEvents.clear(),markers.forEach((t=>{if(t&&t._map){const e=t.getLatLng();if(o.contains(e)){const o=t.eventId;o&&visibleEvents.add(o)}}})),visibleEvents.size===t&&Array.from(visibleEvents).every((o=>visibleEvents.has(o)))||window.dispatchEvent(new CustomEvent("mapBoundsChanged",{detail:{visibleEventIds:Array.from(visibleEvents)}}))}),150))}function updateMapStyle(o){if(!map)return;const t=o?"https://{s}.basemaps.cartocdn.com/rastertiles/dark_all/{z}/{x}/{y}{r}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}{r}.png";currentTileLayer&&map.removeLayer(currentTileLayer),currentTileLayer=L.tileLayer(t,{attribution:"¬© OpenStreetMap contributors"}).addTo(map)}function createMarkerPopup(o){const t=o.rrule?new Date(o.rrule.dtstart):new Date(o.start),e=!!o.rrule;return`\n        <div class="popup-content">\n            <h3>${o.title}</h3>\n            <p>${e?"Weekly on "+t.toLocaleDateString("en-US",{weekday:"long"}):t.toLocaleDateString()}</p>\n            ${o.website?`<p><a href="${o.website}" target="_blank">üåê Website</a></p>`:""}\n            ${o.type?`<p>Type: ${o.type.charAt(0).toUpperCase()+o.type.slice(1)}</p>`:""}\n        </div>\n    `}function updateMarkers(o){if(!map)return;allEventLocations=o.filter((o=>o.location));const t=new Set(o.map((o=>o.id)));markers=markers.filter((o=>!!(o&&o.eventId&&t.has(o.eventId))||(o._map&&o.remove(),markersCache.delete(o.eventId),!1)));const e=new Set(markers.map((o=>o.eventId)));o.forEach((o=>{if(o.location&&!e.has(o.id)){let t=markersCache.get(o.id);t||(t=L.marker(o.location),t.eventId=o.id,t.bindPopup(createMarkerPopup(o)),markersCache.set(o.id,t)),t._map||t.addTo(map),markers.push(t)}})),userLocation&&allEventLocations.length>0&&markers.length===o.length&&setOptimalZoom(userLocation.lat,userLocation.lng,allEventLocations),updateVisibleEvents()}function invalidateMapSize(){map&&(mapResizeTimeout&&clearTimeout(mapResizeTimeout),mapResizeTimeout=setTimeout((()=>{map&&map.invalidateSize({animate:!1,pan:!1})}),100))}function showMarkerPopup(o){const t=markers.find((t=>t.eventId===o));t&&t._map&&(t.openPopup(),map.getBounds().contains(t.getLatLng())||map.panTo(t.getLatLng()))}function showLocationBanner(){if(localStorage.getItem("locationDecision"))return;const o=document.getElementById("location-banner"),t=document.getElementById("location-banner-progress");o&&(o.classList.add("show"),bannerAutoDismissTimer&&clearTimeout(bannerAutoDismissTimer),t&&(t.style.transform="scaleX(1)",t.style.transition="transform 10s linear",setTimeout((()=>{t.style.transform="scaleX(0)"}),50)),bannerAutoDismissTimer=setTimeout((()=>{hideLocationBanner(),bannerAutoDismissTimer=null}),1e4))}function hideLocationBanner(){const o=document.getElementById("location-banner");o&&o.classList.remove("show")}function requestUserLocation(){navigator.geolocation?navigator.geolocation.getCurrentPosition((o=>{const{latitude:t,longitude:e}=o.coords;userLocation={lat:t,lng:e},updateUserLocationMarker(t,e,!1,"Your precise location"),map&&(allEventLocations.length>0?setOptimalZoom(t,e,allEventLocations):map.setView([t,e],12),console.log("Map centered on precise user location")),localStorage.setItem("locationDecision","allowed"),hideLocationBanner()}),(o=>{console.log("Location access denied or failed:",o.message),localStorage.setItem("locationDecision","denied"),hideLocationBanner()}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):console.log("Geolocation not supported")}async function geocodeLocation(o){try{const t=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(o)}&limit=1`),e=await t.json();if(e&&e.length>0){const o=e[0];return{lat:parseFloat(o.lat),lng:parseFloat(o.lon),displayName:o.display_name}}return null}catch(o){return console.error("Geocoding failed:",o),null}}function showLocationModal(){const o=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");o&&(o.classList.add("show"),t&&t.focus())}function hideLocationModal(){const o=document.getElementById("location-modal"),t=document.getElementById("manual-location-input");o&&(o.classList.remove("show"),t&&(t.value=""))}async function handleManualLocation(){const o=document.getElementById("manual-location-input"),t=o?.value?.trim();if(!t)return void alert("Please enter a location");const e=document.getElementById("location-submit"),n=e.textContent;e.textContent="Searching...",e.disabled=!0;try{const o=await geocodeLocation(t);o?(userLocation={lat:o.lat,lng:o.lng},updateUserLocationMarker(o.lat,o.lng,!1,o.displayName),map&&(allEventLocations.length>0?setOptimalZoom(o.lat,o.lng,allEventLocations):map.setView([o.lat,o.lng],12)),localStorage.setItem("locationDecision","manual"),localStorage.setItem("manualLocation",JSON.stringify({lat:o.lat,lng:o.lng,displayName:o.displayName,timestamp:Date.now()})),hideLocationModal(),hideLocationBanner(),console.log("Manual location set:",o.displayName)):alert("Location not found. Please try a different search term.")}catch(o){alert("Failed to find location. Please try again."),console.error("Manual location error:",o)}finally{e.textContent=n,e.disabled=!1}}function setupLocationBanner(){const o=document.getElementById("location-allow"),t=document.getElementById("location-manual"),e=document.getElementById("location-dismiss"),n=document.getElementById("location-modal"),a=document.getElementById("location-modal-close"),i=document.getElementById("location-submit"),l=document.getElementById("location-cancel"),s=document.getElementById("manual-location-input");o&&o.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const o=document.getElementById("location-banner-progress");o&&(o.style.transition="none",o.style.transform="scaleX(0)"),requestUserLocation()})),t&&t.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const o=document.getElementById("location-banner-progress");o&&(o.style.transition="none",o.style.transform="scaleX(0)"),showLocationModal()})),e&&e.addEventListener("click",(()=>{bannerAutoDismissTimer&&(clearTimeout(bannerAutoDismissTimer),bannerAutoDismissTimer=null);const o=document.getElementById("location-banner-progress");o&&(o.style.transition="none",o.style.transform="scaleX(0)"),localStorage.setItem("locationDecision","dismissed"),hideLocationBanner()})),a&&a.addEventListener("click",(()=>{hideLocationModal()})),i&&i.addEventListener("click",(()=>{handleManualLocation()})),l&&l.addEventListener("click",(()=>{hideLocationModal()})),s&&s.addEventListener("keypress",(o=>{"Enter"===o.key&&handleManualLocation()})),n&&n.addEventListener("click",(o=>{o.target===n&&hideLocationModal()}))}window.clearManualLocation=clearManualLocation,window.requestUserLocationFromPopup=requestUserLocationFromPopup,window.showLocationModalFromPopup=showLocationModalFromPopup,window.clearUserLocationFromPopup=clearUserLocationFromPopup;export{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner,setOptimalZoom};