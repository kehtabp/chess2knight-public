let calendar=null,calendarEventSource=null,userLocale=navigator.language||"en-US",allEvents=[],visibleEventIds=new Set;function getLocaleFirstDay(){try{if(console.log("User locale:",userLocale),void 0!==Intl.Locale)try{const e=new Intl.Locale(userLocale);if(e.weekInfo&&void 0!==e.weekInfo.firstDay)return console.log("Using Intl.Locale weekInfo:",e.weekInfo.firstDay),7===e.weekInfo.firstDay?0:e.weekInfo.firstDay}catch(e){console.log("Intl.Locale not available or unsupported")}const e=userLocale.toLowerCase();console.log("Checking locale:",e);const t=e.split("-"),n=t[0],a=t[1];console.log("Language:",n,"Region:",a);return a&&["us","ca","ph","jp","kr","th","tw","il","sa","ae","kw","qa","bh","om","jo","lb","sy","iq","ye","eg","ly","sd","ma","dz","tn","so","dj","er","et","ke","tz","ug","rw","bi","mw","zm","zw","bw","sz","ls","mg","mu","sc","mz","ao","na","za"].includes(a)?(console.log("Region indicates Sunday start"),0):["ja","ko","th"].includes(n)&&!a?(console.log("Language indicates Sunday start"),0):"en"!==n||a&&!["us","ca","ph"].includes(a)?(console.log("Defaulting to Monday start (ISO 8601)"),1):(console.log("English (US/CA/PH) indicates Sunday start"),0)}catch(e){return console.warn("Could not determine locale first day, defaulting to Monday:",e),1}}let dateFormatter=new Intl.DateTimeFormat(userLocale,{weekday:"long",year:"numeric",month:"long",day:"numeric"});function formatDate(e){try{if(!e)return"";if("string"==typeof e){const t=new Date(e);if(isNaN(t.getTime()))return console.error("Invalid date string:",e),"";e=t}return dateFormatter.format(e)}catch(t){return console.error("Error formatting date:",t,e),""}}function createPopupContent(e){try{let t,n,a;return e.rrule?(t=new Date(e.rrule.dtstart),n=new Date(t.getTime()+108e5),a=!1):(t=new Date(e.start),n=new Date(e.end),a="string"!=typeof e.start||!e.start.includes("T")),`\n            <div class="popup-content">\n                <h3>${e.title}</h3>\n                <p>${formatDate(t)}${a?"":` ${t.toLocaleTimeString(userLocale,{hour:"2-digit",minute:"2-digit"})}`}</p>\n                ${a?"":`<p>Ends: ${formatDate(n)} ${n.toLocaleTimeString(userLocale,{hour:"2-digit",minute:"2-digit"})}</p>`}\n                ${e.website?`<p><a href="${e.website}" target="_blank" rel="noopener noreferrer">üåê Visit Website</a></p>`:""}\n                ${e.socials?`\n                    <div class="social-links">\n                        ${e.socials.facebook?`<a href="${e.socials.facebook}" target="_blank" rel="noopener noreferrer" title="Facebook">üìò</a>`:""}\n                        ${e.socials.twitter?`<a href="${e.socials.twitter}" target="_blank" rel="noopener noreferrer" title="Twitter">üê¶</a>`:""}\n                        ${e.socials.instagram?`<a href="${e.socials.instagram}" target="_blank" rel="noopener noreferrer" title="Instagram">üì∏</a>`:""}\n                    </div>\n                `:""}\n            </div>\n        `}catch(t){return console.error("Error creating popup content:",t,e),`<div class="popup-content"><h3>${e.title}</h3></div>`}}function initCalendar(e){console.log("Initializing calendar with events:",e);const t=document.getElementById("calendar");if(!t)return void console.error("Calendar element not found");let n;return allEvents=e,calendar=new FullCalendar.Calendar(t,{initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:""},height:"100%",expandRows:!0,stickyHeaderDates:!0,nowIndicator:!0,handleWindowResize:!0,dayMaxEvents:!1,eventDisplay:"block",displayEventEnd:!0,eventTimeFormat:{hour:"2-digit",minute:"2-digit",hour12:!0},initialDate:"2025-06-07",firstDay:getLocaleFirstDay(),fixedWeekCount:!1,showNonCurrentDates:!1,aspectRatio:1.35,eventDidMount:function(e){const t=createPopupContent(e.event);new tippy(e.el,{content:t,allowHTML:!0,theme:document.body.classList.contains("dark-mode")?"dark":"light",placement:"top",duration:[200,150],offset:[0,10]})},eventClick:function(e){e.event.id&&window.showMarkerPopup&&window.showMarkerPopup(e.event.id)},eventContent:function(e){const t=e.event.extendedProps.type;return{html:`\n                    <div class="fc-event-main-frame">\n                        <div class="fc-event-title-container">\n                            <div class="fc-event-title fc-sticky">\n                                ${e.event.title} \n                                <span class="event-type">${t}</span>\n                            </div>\n                        </div>\n                    </div>\n                `}}}),calendar.render(),window.addEventListener("mapBoundsChanged",(e=>{visibleEventIds=new Set(e.detail.visibleEventIds),updateEventDisplay(allEvents)})),window.addEventListener("resize",(()=>{clearTimeout(n),n=setTimeout((()=>{calendar&&calendar.updateSize()}),100)})),updateEventDisplay(e),console.log("Calendar rendered"),calendar}function updateEventDisplay(e){if(console.log("Updating calendar events..."),calendar){calendar.removeAllEvents();const t=e.filter((e=>!(!e.rrule||!visibleEventIds.has(e.id))||visibleEventIds.has(e.id))).map((e=>{const t={id:e.id,title:e.title,backgroundColor:getEventColor(e.type),borderColor:"transparent",textColor:"#fff"};return e.rrule?{...t,rrule:e.rrule,duration:"03:00",extendedProps:{type:e.type,location:e.location,website:e.website,socials:e.socials}}:{...t,start:e.start,end:e.end,allDay:!e.start.includes("T"),extendedProps:{type:e.type,location:e.location,website:e.website,socials:e.socials}}}));calendar.addEventSource({events:t})}}function getEventColor(e){return{tournament:"#e74c3c",casual:"#3498db",workshop:"#2ecc71",club:"#9b59b6"}[e]||"#95a5a6"}function setCalendarToStartOfWeek(e){if(!calendar)return;const t=new Date,n=t.getDay()-(e||0),a=new Date(t);a.setDate(t.getDate()-n),calendar.gotoDate(a)}export{initCalendar,updateEventDisplay,setCalendarToStartOfWeek,createPopupContent,getLocaleFirstDay};