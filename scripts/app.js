import{initMap as e,updateMapStyle as t,updateMarkers as n,invalidateMapSize as o,showMarkerPopup as s,setupLocationModal as a,setupMyLocationButton as i}from"./map.js";import{initCalendar as r,updateEventDisplay as d,setCalendarToStartOfWeek as l,createPopupContent as c,getLocaleFirstDay as m}from"./calendar.js";let u=[],p=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["casual","club","workshop","tournament"]),h=null,w=null,g=JSON.parse(localStorage.getItem("isMapExpanded"))||!1,f=null;async function v(){try{const e=await fetch("data/events.json");if(e.ok){const t=await e.json();if(t.events&&Array.isArray(t.events)&&t.events.length>0)return{events:t.events,isDemo:!1};throw new Error("No valid events found in events.json")}throw new Error("events.json not available")}catch(e){try{const e=await fetch("assets/mock_events.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return{events:await e.json(),isDemo:!0}}catch(e){throw new Error("Failed to load events data")}}}class y{constructor(){this.banners=new Map,this.container=null,this.init()}init(){this.container=document.getElementById("banner-container"),this.container||(this.container=document.createElement("div"),this.container.id="banner-container",this.container.className="banner-container",document.body.appendChild(this.container))}showBanner(e,t,n="",o={}){this.hideBanner(e);const s=document.createElement("div");return s.id=e,s.className=n,s.innerHTML=t,this.container.appendChild(s),this.banners.set(e,s),setTimeout((()=>{s.classList.add("show")}),10),o.autoHide&&setTimeout((()=>{this.hideBanner(e)}),o.autoHide),s}hideBanner(e){const t=this.banners.get(e);t&&(t.classList.remove("show"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t),this.banners.delete(e)}),150))}hideAllBanners(){this.banners.forEach(((e,t)=>{this.hideBanner(t)}))}hasBanner(e){return this.banners.has(e)}}const E=new y;function b(){E.hasBanner("demo-banner")||E.showBanner("demo-banner",'\n        <div class="demo-banner-content">\n            <span class="demo-icon">üìù</span>\n            <span class="demo-text">Demo: Sample events shown</span>\n            <button class="demo-close" onclick="hideDemoBanner()" title="Close">‚úï</button>\n        </div>\n    ',"demo-banner")}function k(){E.hideBanner("demo-banner")}function L(e){p.has(e)?p.delete(e):p.add(e),localStorage.setItem("activeFilters",JSON.stringify([...p])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),S()}function S(){const e=u.filter((e=>p.has(e.type)));n(e),d(e)}function B(){setTimeout((()=>{if(u&&u.length>0){const e=u.filter((e=>p.has(e.type))).length;h&&markers&&markers.filter((e=>e._map)).length!==e&&S(),w&&0===w.getEvents().length&&e>0&&S()}}),300)}function T(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(g){if(e.classList.add("expanded"),t.textContent="Expand calendar ‚ñ≤‚ñ≤‚ñ≤",w){const e=new Date;w.changeView("dayGridWeek"),w.setOption("firstDay",e.getDay()),w.gotoDate(e)}setTimeout((()=>{o()}),100)}else e.classList.remove("expanded"),t.textContent="Expand map ‚ñº‚ñº‚ñº"}function I(){const e=document.body.classList.toggle("dark-mode");document.documentElement.classList.toggle("dark-mode",e),localStorage.setItem("theme",e?"dark-mode":"light-mode"),t(e)}function O(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(t.disabled)return;t.style.opacity="0.6",t.disabled=!0;let n=[];if(window.captureVisibleEvents&&(n=window.captureVisibleEvents()),e.classList.toggle("expanded"),g=e.classList.contains("expanded"),localStorage.setItem("isMapExpanded",JSON.stringify(g)),t.textContent=g?"Expand calendar ‚ñ≤‚ñ≤‚ñ≤":"Expand map ‚ñº‚ñº‚ñº",w){const e=window.innerWidth<=768;if(g){if(e)w.changeView("listWeek");else{const e=new Date;w.changeView("dayGridWeek"),w.setOption("firstDay",e.getDay())}w.gotoDate(new Date)}else e?w.changeView("listWeek"):(w.changeView("dayGridMonth"),w.setOption("firstDay",m())),w.gotoDate(new Date)}setTimeout((()=>{o(),w&&w.updateSize(),t.style.opacity="1",t.disabled=!1,setTimeout((()=>{D(n)}),200)}),250)}function D(e=[]){h&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,e)}function N(){let e=null,t=[];window.addEventListener("resize",(()=>{null===e&&(e=Date.now(),window.captureVisibleEvents&&(t=window.captureVisibleEvents())),f&&clearTimeout(f),f=setTimeout((()=>{h&&o(),w&&w.updateSize(),setTimeout((()=>{t.length>0&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,t),window.preserveEventsAfterResize&&window.preserveEventsAfterResize(),e=null,t=[]}),100)}),200)}))}function x(){const e=document.getElementById("add-event-modal"),t=document.getElementById("google-form-iframe"),n=document.getElementById("form-container"),o=document.querySelector(".form-loading");if(e){e.classList.add("show");const s="https://docs.google.com/forms/d/e/1fPN93jOB8T0rMzcKNkYyEr0g1JsuYxNcScflrJwelVw/viewform?embedded=true";!t.src&&s.includes("1fPN93jOB8T0rMzcKNkYyEr0g1JsuYxNcScflrJwelVw")?n&&(n.innerHTML='\n                    <div class="form-placeholder">\n                        <h4>üöß Google Form Setup Required</h4>\n                        <p>To enable community event submissions, follow these steps:</p>\n                        \n                        <div class="setup-steps">\n                            <div class="setup-step">\n                                <h5>üìã 1. Create Google Form</h5>\n                                <p>Use our template to create your chess events form:</p>\n                                <a href="GOOGLE_FORM_TEMPLATE.md" target="_blank" class="setup-link">View Form Template</a>\n                            </div>\n                            \n                            <div class="setup-step">\n                                <h5>üîó 2. Get Embed URL</h5>\n                                <p>In your form: Send ‚Üí Embed ‚Üí Copy the iframe src URL</p>\n                            </div>\n                            \n                            <div class="setup-step">\n                                <h5>‚öôÔ∏è 3. Update Configuration</h5>\n                                <p>Replace <code>1fPN93jOB8T0rMzcKNkYyEr0g1JsuYxNcScflrJwelVw</code> in <code>src/scripts/app.js</code></p>\n                            </div>\n                            \n                            <div class="setup-step">\n                                <h5>ü§ñ 4. Setup Auto-Sync</h5>\n                                <p>Follow the complete setup guide for automated approval workflow:</p>\n                                <a href="GOOGLE_SHEETS_SETUP.md" target="_blank" class="setup-link">Complete Setup Guide</a>\n                            </div>\n                        </div>\n                        \n                        <div class="quick-start">\n                            <h5>Quick Start:</h5>\n                            <a href="https://forms.google.com" target="_blank" class="quick-link">Create Google Form ‚Üí</a>\n                        </div>\n                    </div>\n                '):t.src||(o&&(o.style.display="block",o.textContent="Loading form..."),t.src=s,t.style.display="none",t.onload=function(){o&&(o.style.display="none"),t.style.display="block"},t.onerror=function(){n&&(n.innerHTML='\n                        <div class="form-error">\n                            <h4>‚ö†Ô∏è Form Loading Error</h4>\n                            <p>Unable to load the submission form. Please check your configuration.</p>\n                            <button onclick="location.reload()" class="retry-btn">üîÑ Retry</button>\n                        </div>\n                    ')})}}function F(){const e=document.getElementById("add-event-modal");e&&e.classList.remove("show")}function C(){const e=document.getElementById("add-event-modal"),t=document.getElementById("add-event-modal-close");t&&t.addEventListener("click",F),e&&e.addEventListener("click",(t=>{t.target===e&&F()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e?.classList.contains("show")&&F()}))}window.hideDemoBanner=k,window.bannerManager=E,window.showMarkerPopup=s,window.updateEventsDisplay=S,window.preserveEventsAfterResize=B,document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const n=document.documentElement.classList.contains("dark-mode");document.body.classList.toggle("dark-mode",n);const o=JSON.parse(localStorage.getItem("activeFilters"));o&&(p=new Set(o)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",I),document.getElementById("toggle-map")?.addEventListener("click",O),document.getElementById("add-event-btn")?.addEventListener("click",x),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>L(e.dataset.type)))}));const{events:s,isDemo:d}=await v();if(u=s.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),d&&b(),h=await e(),t(n),a(),i(),C(),w=r(u),!w)throw new Error("Failed to initialize calendar");T(),S(),setTimeout((()=>{window.setInitialOptimalZoom&&window.setInitialOptimalZoom()}),500),N()}catch(e){const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));