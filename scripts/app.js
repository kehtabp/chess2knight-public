import{initMap as e,updateMapStyle as t,updateMarkers as n,invalidateMapSize as a,showMarkerPopup as o,setupLocationModal as s,setupMyLocationButton as i}from"./map.js";import{initCalendar as r,updateEventDisplay as d,setCalendarToStartOfWeek as l,createPopupContent as c,getLocaleFirstDay as m}from"./calendar.js";let u=[],w=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["tournament","casual","workshop","club"]),p=null,h=null,g=JSON.parse(localStorage.getItem("isMapExpanded"))||!1,f=null;async function v(){try{const e=await fetch("assets/events.json");if(e.ok){const t=await e.json();if(Array.isArray(t)&&t.length>0)return{events:t,isDemo:!1};throw new Error("No valid events found in events.json")}throw new Error("events.json not available")}catch(e){try{const e=await fetch("assets/mock_events.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return{events:await e.json(),isDemo:!0}}catch(e){throw new Error("Failed to load events data")}}}class y{constructor(){this.banners=new Map,this.container=null,this.init()}init(){this.container=document.getElementById("banner-container"),this.container||(this.container=document.createElement("div"),this.container.id="banner-container",this.container.className="banner-container",document.body.appendChild(this.container))}showBanner(e,t,n="",a={}){this.hideBanner(e);const o=document.createElement("div");return o.id=e,o.className=n,o.innerHTML=t,this.container.appendChild(o),this.banners.set(e,o),setTimeout((()=>{o.classList.add("show")}),10),a.autoHide&&setTimeout((()=>{this.hideBanner(e)}),a.autoHide),o}hideBanner(e){const t=this.banners.get(e);t&&(t.classList.remove("show"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t),this.banners.delete(e)}),150))}hideAllBanners(){this.banners.forEach(((e,t)=>{this.hideBanner(t)}))}hasBanner(e){return this.banners.has(e)}}const E=new y;function b(){E.hasBanner("demo-banner")||E.showBanner("demo-banner",'\n        <div class="demo-banner-content">\n            <span class="demo-icon">üìù</span>\n            <span class="demo-text">Demo: Sample events shown</span>\n            <button class="demo-close" onclick="hideDemoBanner()" title="Close">‚úï</button>\n        </div>\n    ',"demo-banner")}function k(){E.hideBanner("demo-banner")}function D(e){w.has(e)?w.delete(e):w.add(e),localStorage.setItem("activeFilters",JSON.stringify([...w])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",w.has(e.dataset.type))})),B()}function B(){const e=u.filter((e=>w.has(e.type)));n(e),d(e)}function L(){setTimeout((()=>{if(u&&u.length>0){const e=u.filter((e=>w.has(e.type))).length;p&&markers&&markers.filter((e=>e._map)).length!==e&&B(),h&&0===h.getEvents().length&&e>0&&B()}}),300)}function S(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(g){if(e.classList.add("expanded"),t.textContent="Expand calendar ‚ñ≤‚ñ≤‚ñ≤",h){const e=new Date;h.changeView("dayGridWeek"),h.setOption("firstDay",e.getDay()),h.gotoDate(e)}setTimeout((()=>{a()}),100)}else e.classList.remove("expanded"),t.textContent="Expand map ‚ñº‚ñº‚ñº"}function I(){const e=document.body.classList.toggle("dark-mode");document.documentElement.classList.toggle("dark-mode",e),localStorage.setItem("theme",e?"dark-mode":"light-mode"),t(e)}function O(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(t.disabled)return;t.style.opacity="0.6",t.disabled=!0;let n=[];if(window.captureVisibleEvents&&(n=window.captureVisibleEvents()),e.classList.toggle("expanded"),g=e.classList.contains("expanded"),localStorage.setItem("isMapExpanded",JSON.stringify(g)),t.textContent=g?"Expand calendar ‚ñ≤‚ñ≤‚ñ≤":"Expand map ‚ñº‚ñº‚ñº",h){const e=window.innerWidth<=768;if(g){if(e)h.changeView("listWeek");else{const e=new Date;h.changeView("dayGridWeek"),h.setOption("firstDay",e.getDay())}h.gotoDate(new Date)}else e?h.changeView("listWeek"):(h.changeView("dayGridMonth"),h.setOption("firstDay",m())),h.gotoDate(new Date)}setTimeout((()=>{a(),h&&h.updateSize(),t.style.opacity="1",t.disabled=!1,setTimeout((()=>{T(n)}),200)}),250)}function T(e=[]){p&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,e)}function x(){let e=null,t=[];window.addEventListener("resize",(()=>{null===e&&(e=Date.now(),window.captureVisibleEvents&&(t=window.captureVisibleEvents())),f&&clearTimeout(f),f=setTimeout((()=>{p&&a(),h&&h.updateSize(),setTimeout((()=>{t.length>0&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,t),window.preserveEventsAfterResize&&window.preserveEventsAfterResize(),e=null,t=[]}),100)}),200)}))}window.hideDemoBanner=k,window.bannerManager=E,window.showMarkerPopup=o,window.updateEventsDisplay=B,window.preserveEventsAfterResize=L,document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const n=document.documentElement.classList.contains("dark-mode");document.body.classList.toggle("dark-mode",n);const a=JSON.parse(localStorage.getItem("activeFilters"));a&&(w=new Set(a)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",w.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",I),document.getElementById("toggle-map")?.addEventListener("click",O),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>D(e.dataset.type)))}));const{events:o,isDemo:d}=await v();if(u=o.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),d&&b(),p=await e(),t(n),s(),i(),h=r(u),!h)throw new Error("Failed to initialize calendar");S(),B(),setTimeout((()=>{window.setInitialOptimalZoom&&window.setInitialOptimalZoom()}),500),x()}catch(e){const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));