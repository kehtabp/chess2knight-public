import{initMap as e,updateMapStyle as t,updateMarkers as n,invalidateMapSize as o,showMarkerPopup as s,setupLocationModal as a,setupMyLocationButton as i}from"./map.js";import{initCalendar as r,updateEventDisplay as d,setCalendarToStartOfWeek as l,createPopupContent as c,getLocaleFirstDay as m}from"./calendar.js";let u=[],p=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["casual","club","workshop","tournament"]),f=null,h=null,v=JSON.parse(localStorage.getItem("isMapExpanded"))||!1,y=null;async function g(){try{const e=await fetch("data/events.json");if(e.ok){const t=await e.json();if(t.events&&Array.isArray(t.events)&&t.events.length>0)return{events:t.events,isDemo:!1};throw new Error("No valid events found in events.json")}throw new Error("events.json not available")}catch(e){try{const e=await fetch("assets/mock_events.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return{events:await e.json(),isDemo:!0}}catch(e){throw new Error("Failed to load events data")}}}class w{constructor(){this.banners=new Map,this.container=null,this.init()}init(){this.container=document.getElementById("banner-container"),this.container||(this.container=document.createElement("div"),this.container.id="banner-container",this.container.className="banner-container",document.body.appendChild(this.container))}showBanner(e,t,n="",o={}){this.hideBanner(e);const s=document.createElement("div");return s.id=e,s.className=n,s.innerHTML=t,this.container.appendChild(s),this.banners.set(e,s),setTimeout((()=>{s.classList.add("show")}),10),o.autoHide&&setTimeout((()=>{this.hideBanner(e)}),o.autoHide),s}hideBanner(e){const t=this.banners.get(e);t&&(t.classList.remove("show"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t),this.banners.delete(e)}),150))}hideAllBanners(){this.banners.forEach(((e,t)=>{this.hideBanner(t)}))}hasBanner(e){return this.banners.has(e)}}const E=new w;function b(){E.hasBanner("demo-banner")||E.showBanner("demo-banner",'\n        <div class="demo-banner-content">\n            <span class="demo-icon">üìù</span>\n            <span class="demo-text">Demo: Sample events shown</span>\n            <button class="demo-close" onclick="hideDemoBanner()" title="Close">‚úï</button>\n        </div>\n    ',"demo-banner")}function k(){E.hideBanner("demo-banner")}function I(e){p.has(e)?1===p.size?(p.clear(),["casual","club","workshop","tournament"].forEach((e=>p.add(e)))):p.delete(e):p.add(e),localStorage.setItem("activeFilters",JSON.stringify([...p])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),L()}function L(){const e=u.filter((e=>p.has(e.type)));n(e),d(e)}function T(){setTimeout((()=>{if(u&&u.length>0){const e=u.filter((e=>p.has(e.type))).length;f&&markers&&markers.filter((e=>e._map)).length!==e&&L(),h&&0===h.getEvents().length&&e>0&&L()}}),300)}function B(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(v){if(e.classList.add("expanded"),t.textContent="Expand calendar ‚ñ≤‚ñ≤‚ñ≤",h){const e=new Date;h.changeView("dayGridWeek"),h.setOption("firstDay",e.getDay()),h.gotoDate(e)}setTimeout((()=>{o()}),100)}else e.classList.remove("expanded"),t.textContent="Expand map ‚ñº‚ñº‚ñº"}function S(){const e=document.body.classList.toggle("dark-mode");document.documentElement.classList.toggle("dark-mode",e),localStorage.setItem("theme",e?"dark-mode":"light-mode"),t(e)}function D(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(t.disabled)return;t.style.opacity="0.6",t.disabled=!0;let n=[];if(window.captureVisibleEvents&&(n=window.captureVisibleEvents()),e.classList.toggle("expanded"),v=e.classList.contains("expanded"),localStorage.setItem("isMapExpanded",JSON.stringify(v)),t.textContent=v?"Expand calendar ‚ñ≤‚ñ≤‚ñ≤":"Expand map ‚ñº‚ñº‚ñº",h){const e=new Date;h.gotoDate(e),setTimeout((()=>{h.render()}),100)}setTimeout((()=>{o(),h&&h.updateSize(),t.style.opacity="1",t.disabled=!1,setTimeout((()=>{F(n)}),200)}),250)}function A(){if(!h)return;let e=!1;const t=document.getElementById("calendar");if(!t)return;const n=(t,n)=>{t&&t.addEventListener("scroll",(t=>{v&&(e||(e=!0,D(),setTimeout((()=>{e=!1}),1e3)))}),{passive:!0})};n(t);const o=()=>{[{selector:".fc-view-harness",name:"fc-view-harness"},{selector:".fc-scroller",name:"fc-scroller"},{selector:".fc-scrollgrid",name:"fc-scrollgrid"},{selector:".fc-daygrid-body",name:"fc-daygrid-body"},{selector:".fc-view-harness-active",name:"fc-view-harness-active"}].forEach((({selector:e,name:o})=>{t.querySelectorAll(e).forEach(((e,t)=>{n(e)}))})),t.addEventListener("scroll",(t=>{v&&(e||(e=!0,D(),setTimeout((()=>{e=!1}),1e3)))}),{capture:!0,passive:!0})};o(),setTimeout(o,500),setTimeout(o,1e3)}function F(e=[]){f&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,e)}function x(){let e=null,t=[];window.addEventListener("resize",(()=>{null===e&&(e=Date.now(),window.captureVisibleEvents&&(t=window.captureVisibleEvents())),y&&clearTimeout(y),y=setTimeout((()=>{f&&o(),h&&h.updateSize(),setTimeout((()=>{t.length>0&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,t),window.preserveEventsAfterResize&&window.preserveEventsAfterResize(),e=null,t=[]}),100)}),200)}))}function C(){let e={networkIdle:!1,calendarReady:!1,mapReady:!1,userInteracted:!1};if("complete"===document.readyState?(e.networkIdle=!0,o()):window.addEventListener("load",(()=>{setTimeout((()=>{e.networkIdle=!0,o()}),500)})),h&&h.getEvents)e.calendarReady=!0,o();else{const t=setInterval((()=>{h&&h.getEvents&&(e.calendarReady=!0,clearInterval(t),o())}),100);setTimeout((()=>{e.calendarReady||(e.calendarReady=!0,clearInterval(t),o())}),5e3)}if(f&&f.getZoom)e.mapReady=!0,o();else{const t=setInterval((()=>{f&&f.getZoom&&(e.mapReady=!0,clearInterval(t),o())}),100);setTimeout((()=>{e.mapReady||(e.mapReady=!0,clearInterval(t),o())}),5e3)}const t=["click","scroll","keydown","touchstart"],n=()=>{e.userInteracted||(e.userInteracted=!0,t.forEach((e=>{document.removeEventListener(e,n,{passive:!0})})),o())};function o(){const t=Object.values(e).every((e=>e)),n=e.networkIdle&&e.calendarReady&&e.mapReady;(t||n)&&R()}t.forEach((e=>{document.addEventListener(e,n,{passive:!0})})),setTimeout((()=>{e.userInteracted||(e.userInteracted=!0,o())}),1e4)}function O(){return"https://docs.google.com/forms/d/e/1FAIpQLSfD68SZPw9Tb4VVjvyyz6dgblnFnj2pV8qABEnvtL90-1pkyw/viewform?embedded=true"+(document.body.classList.contains("dark-mode")?"&theme=dark":"")}function R(){const e=document.getElementById("google-form-iframe");if(!e)return;if(e.src&&e.src.includes("docs.google.com"))return;const t=O();e.style.display="none",e.style.visibility="hidden",e.style.position="absolute",e.style.top="-9999px",e.onload=function(){},e.onerror=function(e){},e.src=t}function j(){const e=document.getElementById("add-event-modal"),t=document.getElementById("google-form-iframe"),n=document.getElementById("form-container"),o=document.querySelector(".form-loading");if(e){e.classList.add("show");const s=O();if(!t.src||t.src===window.location.href||t.src.includes("localhost")){o&&(o.style.display="block",o.innerHTML='\n                    <div class="loading-spinner"></div>\n                    <div>Loading Google Form...</div>\n                    <small>This may take 5-10 seconds</small>\n                '),t.style.display="none";let e=!1;const a=setTimeout((()=>{e||N(n)}),1e4);t.onload=function(){e=!0,clearTimeout(a),setTimeout((()=>{o&&(o.style.display="none"),t.style.display="block",setTimeout((()=>{0===t.offsetHeight&&0===t.offsetWidth&&N(n)}),2e3)}),500)},t.onerror=function(t){e=!0,clearTimeout(a),N(n)},t.src=s,setTimeout((()=>{if(!e)try{null===t.contentDocument&&"none"===t.style.display&&N(n)}catch(e){}}),3e3)}else t.style.position="",t.style.top="",t.style.visibility="",t.offsetHeight>100&&t.offsetWidth>200?(o&&(o.style.display="none"),t.style.display="block"):(o&&(o.style.display="none"),t.style.display="block",setTimeout((()=>{t.offsetHeight<50&&(t.src="https://docs.google.com/forms/d/e/1FAIpQLSfD68SZPw9Tb4VVjvyyz6dgblnFnj2pV8qABEnvtL90-1pkyw/viewform?embedded=true",setTimeout((()=>{t.offsetHeight<50&&N(n)}),3e3))}),2e3))}}function N(e){if(e){const t=O().replace("embedded=true","usp=sf_link");e.innerHTML=`\n            <div class="form-error">\n                <h4>üö´ Google Form Embedding Blocked</h4>\n                <p>Google Forms often can't be embedded due to security restrictions. This is normal!</p>\n                <p><strong>‚ú® Easy Solution:</strong> Click the link below to open the form in a new tab.</p>\n                \n                <div class="form-alternatives">\n                    <div class="form-option primary">\n                        <h5>üîó Open Chess Event Submission Form</h5>\n                        <a href="${t}" target="_blank" class="external-form-link">\n                            üìù Submit Your Chess Event ‚Üí\n                        </a>\n                        <p class="form-note">Opens in new tab - takes 30 seconds to complete</p>\n                    </div>\n                    \n                    <div class="form-fallback">\n                        <h5>üìß Alternative: Submit via Email</h5>\n                        <a href="mailto:events@chess2knight.com?subject=Chess Event Submission&body=Event Name:%0D%0AEvent Type (club/tournament/workshop/casual):%0D%0ADate & Time:%0D%0ALocation (address):%0D%0ADescription:%0D%0AContact Info:%0D%0AWebsite (optional):" class="email-link">\n                            üìß events@chess2knight.com\n                        </a>\n                        <p class="form-note">Include: Name, Type, Date/Time, Location, Description, Contact & Website</p>\n                    </div>\n                </div>\n                \n                <button onclick="hideAddEventModal()" class="close-btn">‚úÖ Got it, thanks!</button>\n            </div>\n        `}}function H(){const e=document.getElementById("add-event-modal");e&&e.classList.remove("show")}function M(){const e=document.getElementById("add-event-modal"),t=document.getElementById("add-event-modal-close");t&&t.addEventListener("click",H),e&&e.addEventListener("click",(t=>{t.target===e&&H()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e?.classList.contains("show")&&H()}))}window.hideDemoBanner=k,window.bannerManager=E,window.showMarkerPopup=s,window.updateEventsDisplay=L,window.preserveEventsAfterResize=T,document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const n=document.documentElement.classList.contains("dark-mode");document.body.classList.toggle("dark-mode",n);const o=JSON.parse(localStorage.getItem("activeFilters"));o&&(p=new Set(o)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",S),document.getElementById("toggle-map")?.addEventListener("click",D),document.getElementById("add-event-btn")?.addEventListener("click",j),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>I(e.dataset.type)))}));const{events:s,isDemo:d}=await g();if(u=s.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),d&&b(),f=await e(),t(n),a(),i(),M(),h=r(u),!h)throw new Error("Failed to initialize calendar");B(),A(),L(),setTimeout((()=>{window.setInitialOptimalZoom&&window.setInitialOptimalZoom()}),500),x(),C()}catch(e){const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));