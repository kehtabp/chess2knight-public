import{initMap as e,updateMapStyle as t,updateMarkers as n,invalidateMapSize as o,showMarkerPopup as s,setupLocationModal as a,setupMyLocationButton as i}from"./map.js";import{initCalendar as d,updateEventDisplay as l,setCalendarToStartOfWeek as r,createPopupContent as c,getLocaleFirstDay as m}from"./calendar.js";let u=[],p=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["casual","club","workshop","tournament"]),h=null,w=null,f=JSON.parse(localStorage.getItem("isMapExpanded"))||!1,g=null;async function y(){try{const e=await fetch("data/events.json");if(e.ok){const t=await e.json();if(t.events&&Array.isArray(t.events)&&t.events.length>0)return{events:t.events,isDemo:!1};throw new Error("No valid events found in events.json")}throw new Error("events.json not available")}catch(e){try{const e=await fetch("assets/mock_events.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return{events:await e.json(),isDemo:!0}}catch(e){throw new Error("Failed to load events data")}}}class v{constructor(){this.banners=new Map,this.container=null,this.init()}init(){this.container=document.getElementById("banner-container"),this.container||(this.container=document.createElement("div"),this.container.id="banner-container",this.container.className="banner-container",document.body.appendChild(this.container))}showBanner(e,t,n="",o={}){this.hideBanner(e);const s=document.createElement("div");return s.id=e,s.className=n,s.innerHTML=t,this.container.appendChild(s),this.banners.set(e,s),setTimeout((()=>{s.classList.add("show")}),10),o.autoHide&&setTimeout((()=>{this.hideBanner(e)}),o.autoHide),s}hideBanner(e){const t=this.banners.get(e);t&&(t.classList.remove("show"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t),this.banners.delete(e)}),150))}hideAllBanners(){this.banners.forEach(((e,t)=>{this.hideBanner(t)}))}hasBanner(e){return this.banners.has(e)}}const E=new v;function b(){E.hasBanner("demo-banner")||E.showBanner("demo-banner",'\n        <div class="demo-banner-content">\n            <span class="demo-icon">üìù</span>\n            <span class="demo-text">Demo: Sample events shown</span>\n            <button class="demo-close" onclick="hideDemoBanner()" title="Close">‚úï</button>\n        </div>\n    ',"demo-banner")}function k(){E.hideBanner("demo-banner")}function L(e){p.has(e)?p.delete(e):p.add(e),localStorage.setItem("activeFilters",JSON.stringify([...p])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),D()}function D(){const e=u.filter((e=>p.has(e.type)));n(e),l(e)}function B(){setTimeout((()=>{if(u&&u.length>0){const e=u.filter((e=>p.has(e.type))).length;h&&markers&&markers.filter((e=>e._map)).length!==e&&D(),w&&0===w.getEvents().length&&e>0&&D()}}),300)}function S(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(f){if(e.classList.add("expanded"),t.textContent="Expand calendar ‚ñ≤‚ñ≤‚ñ≤",w){const e=new Date;w.changeView("dayGridWeek"),w.setOption("firstDay",e.getDay()),w.gotoDate(e)}setTimeout((()=>{o()}),100)}else e.classList.remove("expanded"),t.textContent="Expand map ‚ñº‚ñº‚ñº"}function T(){const e=document.body.classList.toggle("dark-mode");document.documentElement.classList.toggle("dark-mode",e),localStorage.setItem("theme",e?"dark-mode":"light-mode"),t(e)}function I(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(t.disabled)return;t.style.opacity="0.6",t.disabled=!0;let n=[];if(window.captureVisibleEvents&&(n=window.captureVisibleEvents()),e.classList.toggle("expanded"),f=e.classList.contains("expanded"),localStorage.setItem("isMapExpanded",JSON.stringify(f)),t.textContent=f?"Expand calendar ‚ñ≤‚ñ≤‚ñ≤":"Expand map ‚ñº‚ñº‚ñº",w){const e=window.innerWidth<=768;if(f){if(e)w.changeView("listWeek");else{const e=new Date;w.changeView("dayGridWeek"),w.setOption("firstDay",e.getDay())}w.gotoDate(new Date)}else e?w.changeView("listWeek"):(w.changeView("dayGridMonth"),w.setOption("firstDay",m())),w.gotoDate(new Date)}setTimeout((()=>{o(),w&&w.updateSize(),t.style.opacity="1",t.disabled=!1,setTimeout((()=>{A(n)}),200)}),250)}function A(e=[]){h&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,e)}function C(){let e=null,t=[];window.addEventListener("resize",(()=>{null===e&&(e=Date.now(),window.captureVisibleEvents&&(t=window.captureVisibleEvents())),g&&clearTimeout(g),g=setTimeout((()=>{h&&o(),w&&w.updateSize(),setTimeout((()=>{t.length>0&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,t),window.preserveEventsAfterResize&&window.preserveEventsAfterResize(),e=null,t=[]}),100)}),200)}))}function F(){const e=document.getElementById("add-event-modal"),t=document.getElementById("google-form-iframe"),n=document.getElementById("form-container"),o=document.querySelector(".form-loading");if(e){e.classList.add("show");const s="https://docs.google.com/forms/d/e/1FAIpQLSfD68SZPw9Tb4VVjvyyz6dgblnFnj2pV8qABEnvtL90-1pkyw/viewform?embedded=true";if(t.src)o&&(o.style.display="block",o.textContent="Checking form..."),setTimeout((()=>{try{t.contentWindow&&t.offsetHeight>100&&t.offsetWidth>0?(o&&(o.style.display="none"),t.style.display="block"):x(n)}catch(e){t.offsetHeight>100?(o&&(o.style.display="none"),t.style.display="block"):x(n)}}),500);else{o&&(o.style.display="block",o.textContent="Loading form..."),t.style.display="none";let e=!1;const a=setTimeout((()=>{e||x(n)}),5e3);t.onload=function(){e=!0,clearTimeout(a),setTimeout((()=>{try{t.contentWindow&&t.offsetHeight>0&&t.offsetWidth>0?(o&&(o.style.display="none"),t.style.display="block"):x(n)}catch(e){t.offsetHeight>100?(o&&(o.style.display="none"),t.style.display="block"):x(n)}}),1e3)},t.onerror=function(t){e=!0,clearTimeout(a),x(n)},t.src=s,setTimeout((()=>{if(!e)try{null===t.contentDocument&&"none"===t.style.display&&x(n)}catch(e){}}),3e3)}}}function x(e){e&&(e.innerHTML='\n            <div class="form-error">\n                <h4>üö´ Google Form Embedding Blocked</h4>\n                <p>Google Forms often can\'t be embedded due to security restrictions. This is normal!</p>\n                <p><strong>‚ú® Easy Solution:</strong> Click the link below to open the form in a new tab.</p>\n                \n                <div class="form-alternatives">\n                    <div class="form-option primary">\n                        <h5>üîó Open Chess Event Submission Form</h5>\n                        <a href="https://docs.google.com/forms/d/e/1FAIpQLSfD68SZPw9Tb4VVjvyyz6dgblnFnj2pV8qABEnvtL90-1pkyw/viewform" target="_blank" class="external-form-link">\n                            üìù Submit Your Chess Event ‚Üí\n                        </a>\n                        <p class="form-note">Opens in new tab - takes 30 seconds to complete</p>\n                    </div>\n                    \n                    <div class="form-fallback">\n                        <h5>üìß Alternative: Submit via Email</h5>\n                        <a href="mailto:events@chess2knight.com?subject=Chess Event Submission&body=Event Name:%0D%0AEvent Type (club/tournament/workshop/casual):%0D%0ADate & Time:%0D%0ALocation (address):%0D%0ADescription:%0D%0AContact Info:%0D%0AWebsite (optional):" class="email-link">\n                            üìß events@chess2knight.com\n                        </a>\n                        <p class="form-note">Include: Name, Type, Date/Time, Location, Description, Contact & Website</p>\n                    </div>\n                </div>\n                \n                <button onclick="hideAddEventModal()" class="close-btn">‚úÖ Got it, thanks!</button>\n            </div>\n        ')}function O(){const e=document.getElementById("add-event-modal");e&&e.classList.remove("show")}function V(){const e=document.getElementById("add-event-modal"),t=document.getElementById("add-event-modal-close");t&&t.addEventListener("click",O),e&&e.addEventListener("click",(t=>{t.target===e&&O()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e?.classList.contains("show")&&O()}))}window.hideDemoBanner=k,window.bannerManager=E,window.showMarkerPopup=s,window.updateEventsDisplay=D,window.preserveEventsAfterResize=B,document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const n=document.documentElement.classList.contains("dark-mode");document.body.classList.toggle("dark-mode",n);const o=JSON.parse(localStorage.getItem("activeFilters"));o&&(p=new Set(o)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",T),document.getElementById("toggle-map")?.addEventListener("click",I),document.getElementById("add-event-btn")?.addEventListener("click",F),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>L(e.dataset.type)))}));const{events:s,isDemo:l}=await y();if(u=s.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),l&&b(),h=await e(),t(n),a(),i(),V(),w=d(u),!w)throw new Error("Failed to initialize calendar");S(),D(),setTimeout((()=>{window.setInitialOptimalZoom&&window.setInitialOptimalZoom()}),500),C()}catch(e){const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));