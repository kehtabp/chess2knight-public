import{initMap as e,updateMapStyle as t,updateMarkers as n,invalidateMapSize as o,showMarkerPopup as s,setupLocationModal as a,setupMyLocationButton as i}from"./map.js";import{initCalendar as r,updateEventDisplay as d,setCalendarToStartOfWeek as l,createPopupContent as c,getLocaleFirstDay as m}from"./calendar.js";let u=[],p=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["casual","club","workshop","tournament"]),v=null,f=null,y=JSON.parse(localStorage.getItem("isMapExpanded"))||!1,h=null;async function w(){try{const e=await fetch("data/events.json");if(e.ok){const t=await e.json();if(t.events&&Array.isArray(t.events)&&t.events.length>0)return{events:t.events,isDemo:!1};throw new Error("No valid events found in events.json")}throw new Error("events.json not available")}catch(e){try{const e=await fetch("assets/mock_events.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return{events:await e.json(),isDemo:!0}}catch(e){throw new Error("Failed to load events data")}}}class g{constructor(){this.banners=new Map,this.container=null,this.init()}init(){this.container=document.getElementById("banner-container"),this.container||(this.container=document.createElement("div"),this.container.id="banner-container",this.container.className="banner-container",document.body.appendChild(this.container))}showBanner(e,t,n="",o={}){this.hideBanner(e);const s=document.createElement("div");return s.id=e,s.className=n,s.innerHTML=t,this.container.appendChild(s),this.banners.set(e,s),setTimeout((()=>{s.classList.add("show")}),10),o.autoHide&&setTimeout((()=>{this.hideBanner(e)}),o.autoHide),s}hideBanner(e){const t=this.banners.get(e);t&&(t.classList.remove("show"),setTimeout((()=>{t.parentNode&&t.parentNode.removeChild(t),this.banners.delete(e)}),150))}hideAllBanners(){this.banners.forEach(((e,t)=>{this.hideBanner(t)}))}hasBanner(e){return this.banners.has(e)}}const E=new g;function b(){E.hasBanner("demo-banner")||E.showBanner("demo-banner",'\n        <div class="demo-banner-content">\n            <span class="demo-icon">📝</span>\n            <span class="demo-text">Demo: Sample events shown</span>\n            <button class="demo-close" onclick="hideDemoBanner()" title="Close">✕</button>\n        </div>\n    ',"demo-banner")}function k(){E.hideBanner("demo-banner")}function I(){if(localStorage.getItem("welcomeBannerDismissed"))return;const e=document.getElementById("welcome-banner");e&&e.classList.add("show")}function L(){const e=document.getElementById("welcome-banner");e&&e.classList.remove("show")}function T(){const e=document.getElementById("welcome-banner"),t=document.getElementById("welcome-close"),n=document.getElementById("welcome-got-it"),o=document.getElementById("welcome-dont-show");t&&t.addEventListener("click",L),n&&n.addEventListener("click",L),o&&o.addEventListener("click",(()=>{localStorage.setItem("welcomeBannerDismissed","true"),L()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e?.classList.contains("show")&&L()})),e&&e.addEventListener("click",(t=>{t.target===e&&L()}))}function B(e){p.has(e)?1===p.size?(p.clear(),["casual","club","workshop","tournament"].forEach((e=>p.add(e)))):p.delete(e):p.add(e),localStorage.setItem("activeFilters",JSON.stringify([...p])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),A()}function A(){const e=u.filter((e=>p.has(e.type)));n(e),d(e)}function D(){setTimeout((()=>{if(u&&u.length>0){const e=u.filter((e=>p.has(e.type))).length;v&&markers&&markers.filter((e=>e._map)).length!==e&&A(),f&&0===f.getEvents().length&&e>0&&A()}}),300)}function S(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");window.isMapExpanded=y,y?(e.classList.add("expanded"),t.textContent="Expand calendar ▲▲▲",setTimeout((()=>{o()}),100)):(e.classList.remove("expanded"),t.textContent="Expand map ▼▼▼")}function R(){const e=document.body.classList.toggle("dark-mode");document.documentElement.classList.toggle("dark-mode",e),localStorage.setItem("theme",e?"dark-mode":"light-mode"),t(e)}function C(){if(!f)return;let e=!1;const t=document.getElementById("calendar");if(!t)return;const n=(t,n)=>{t&&t.addEventListener("scroll",(t=>{y&&(e||(e=!0,toggleMap(),setTimeout((()=>{e=!1}),1e3)))}),{passive:!0})};n(t);const o=()=>{[{selector:".fc-view-harness",name:"fc-view-harness"},{selector:".fc-scroller",name:"fc-scroller"},{selector:".fc-scrollgrid",name:"fc-scrollgrid"},{selector:".fc-daygrid-body",name:"fc-daygrid-body"},{selector:".fc-view-harness-active",name:"fc-view-harness-active"}].forEach((({selector:e,name:o})=>{t.querySelectorAll(e).forEach(((e,t)=>{n(e)}))})),t.addEventListener("scroll",(t=>{y&&(e||(e=!0,toggleMap(),setTimeout((()=>{e=!1}),1e3)))}),{capture:!0,passive:!0})};o(),setTimeout(o,500),setTimeout(o,1e3)}function F(e={events:[],userLocationVisible:!1}){v&&(Array.isArray(e)&&(e={events:e,userLocationVisible:!1}),window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,e))}function M(){let e=null,t={events:[],userLocationVisible:!1};window.addEventListener("resize",(()=>{null===e&&(e=Date.now(),window.captureVisibleEvents&&(t=window.captureVisibleEvents())),h&&clearTimeout(h),h=setTimeout((()=>{v&&o(),f&&f.updateSize(),setTimeout((()=>{(t.visibleEventCount>0||t.userLocationVisible)&&window.setOptimalZoomFromApp&&window.setOptimalZoomFromApp(u,t),window.preserveEventsAfterResize&&window.preserveEventsAfterResize(),e=null,t={events:[],userLocationVisible:!1}}),100)}),200)}))}function x(){let e={networkIdle:!1,calendarReady:!1,mapReady:!1,userInteracted:!1};if("complete"===document.readyState?(e.networkIdle=!0,o()):window.addEventListener("load",(()=>{setTimeout((()=>{e.networkIdle=!0,o()}),500)})),f&&f.getEvents)e.calendarReady=!0,o();else{const t=setInterval((()=>{f&&f.getEvents&&(e.calendarReady=!0,clearInterval(t),o())}),100);setTimeout((()=>{e.calendarReady||(e.calendarReady=!0,clearInterval(t),o())}),5e3)}if(v&&v.getZoom)e.mapReady=!0,o();else{const t=setInterval((()=>{v&&v.getZoom&&(e.mapReady=!0,clearInterval(t),o())}),100);setTimeout((()=>{e.mapReady||(e.mapReady=!0,clearInterval(t),o())}),5e3)}const t=["click","scroll","keydown","touchstart"],n=()=>{e.userInteracted||(e.userInteracted=!0,t.forEach((e=>{document.removeEventListener(e,n,{passive:!0})})),o())};function o(){const t=Object.values(e).every((e=>e)),n=e.networkIdle&&e.calendarReady&&e.mapReady;(t||n)&&j()}t.forEach((e=>{document.addEventListener(e,n,{passive:!0})})),setTimeout((()=>{e.userInteracted||(e.userInteracted=!0,o())}),1e4)}function O(){return"https://docs.google.com/forms/d/e/1FAIpQLSfD68SZPw9Tb4VVjvyyz6dgblnFnj2pV8qABEnvtL90-1pkyw/viewform?embedded=true"+(document.body.classList.contains("dark-mode")?"&theme=dark":"")}function j(){const e=document.getElementById("google-form-iframe");if(!e)return;if(e.src&&e.src.includes("docs.google.com"))return;const t=O();e.style.display="none",e.style.visibility="hidden",e.style.position="absolute",e.style.top="-9999px",e.onload=function(){},e.onerror=function(e){},e.src=t}function N(){const e=document.getElementById("add-event-modal"),t=document.getElementById("google-form-iframe"),n=document.getElementById("form-container"),o=document.querySelector(".form-loading");if(e){e.classList.add("show");const s=O();if(!t.src||t.src===window.location.href||t.src.includes("localhost")){o&&(o.style.display="block",o.innerHTML='\n                    <div class="loading-spinner"></div>\n                    <div>Loading Google Form...</div>\n                    <small>This may take 5-10 seconds</small>\n                '),t.style.display="none";let e=!1;const a=setTimeout((()=>{e||V(n)}),1e4);t.onload=function(){e=!0,clearTimeout(a),setTimeout((()=>{o&&(o.style.display="none"),t.style.display="block",setTimeout((()=>{0===t.offsetHeight&&0===t.offsetWidth&&V(n)}),2e3)}),500)},t.onerror=function(t){e=!0,clearTimeout(a),V(n)},t.src=s,setTimeout((()=>{if(!e)try{null===t.contentDocument&&"none"===t.style.display&&V(n)}catch(e){}}),3e3)}else t.style.position="",t.style.top="",t.style.visibility="",t.offsetHeight>100&&t.offsetWidth>200?(o&&(o.style.display="none"),t.style.display="block"):(o&&(o.style.display="none"),t.style.display="block",setTimeout((()=>{t.offsetHeight<50&&(t.src="https://docs.google.com/forms/d/e/1FAIpQLSfD68SZPw9Tb4VVjvyyz6dgblnFnj2pV8qABEnvtL90-1pkyw/viewform?embedded=true",setTimeout((()=>{t.offsetHeight<50&&V(n)}),3e3))}),2e3))}}function V(e){if(e){const t=O().replace("embedded=true","usp=sf_link");e.innerHTML=`\n            <div class="form-error">\n                <h4>🚫 Google Form Embedding Blocked</h4>\n                <p>Google Forms often can't be embedded due to security restrictions. This is normal!</p>\n                <p><strong>✨ Easy Solution:</strong> Click the link below to open the form in a new tab.</p>\n                \n                <div class="form-alternatives">\n                    <div class="form-option primary">\n                        <h5>🔗 Open Chess Event Submission Form</h5>\n                        <a href="${t}" target="_blank" class="external-form-link">\n                            📝 Submit Your Chess Event →\n                        </a>\n                        <p class="form-note">Opens in new tab - takes 30 seconds to complete</p>\n                    </div>\n                    \n                    <div class="form-fallback">\n                        <h5>📧 Alternative: Submit via Email</h5>\n                        <a href="mailto:events@chess2knight.com?subject=Chess Event Submission&body=Event Name:%0D%0AEvent Type (club/tournament/workshop/casual):%0D%0ADate & Time:%0D%0ALocation (address):%0D%0ADescription:%0D%0AContact Info:%0D%0AWebsite (optional):" class="email-link">\n                            📧 events@chess2knight.com\n                        </a>\n                        <p class="form-note">Include: Name, Type, Date/Time, Location, Description, Contact & Website</p>\n                    </div>\n                </div>\n                \n                <button onclick="hideAddEventModal()" class="close-btn">✅ Got it, thanks!</button>\n            </div>\n        `}}function H(){const e=document.getElementById("add-event-modal");e&&e.classList.remove("show")}function $(){return"https://docs.google.com/forms/d/e/1FAIpQLScjjaGNZ394HpOnnd76F5olOxSwmUMlRboe2EC8dbPN-9vDEA/viewform?embedded=true"+(document.body.classList.contains("dark-mode")?"&theme=dark":"")}function Z(e,t,n){const o=document.getElementById("report-modal"),s=document.getElementById("report-form-iframe"),a=document.getElementById("report-form-container"),i=document.querySelector(".report-form-loading"),r=document.getElementById("reported-event-name");if(o){o.classList.add("show"),r&&(r.textContent=t);const d=$()+`&entry.441517567=${encodeURIComponent(e)}`+`&entry.185748428=${encodeURIComponent(t)}`+`&entry.825749401=${encodeURIComponent(n)}`;if(!s.src||s.src===window.location.href||s.src.includes("localhost")){i&&(i.style.display="block",i.innerHTML='\n                    <div class="loading-spinner"></div>\n                    <div>Loading report form...</div>\n                    <small>This may take a few seconds</small>\n                '),s.style.display="none";let o=!1;const r=setTimeout((()=>{o||z(a,e,t,n)}),1e4);s.onload=function(){o=!0,clearTimeout(r),setTimeout((()=>{i&&(i.style.display="none"),s.style.display="block"}),500)},s.onerror=function(s){o=!0,clearTimeout(r),z(a,e,t,n)},s.src=d}else i&&(i.style.display="none"),s.style.display="block"}}function z(e,t,n,o){e&&(e.innerHTML=`\n            <div class="form-error">\n                <h4>🚫 Report Form Temporarily Unavailable</h4>\n                <p>The embedded form is not loading properly. Please use one of the alternatives below to report this event.</p>\n                \n                <div class="form-alternatives">\n                    <div class="form-option primary">\n                        <h5>📧 Report via Email</h5>\n                        <a href="mailto:reports@chess2knight.com?subject=Event Report: ${encodeURIComponent(n)}&body=Event ID: ${encodeURIComponent(t)}%0D%0AEvent Name: ${encodeURIComponent(n)}%0D%0AEvent Type: ${encodeURIComponent(o)}%0D%0A%0D%0AReport Type:%0D%0A[ ] Event is cancelled%0D%0A[ ] Wrong date/time%0D%0A[ ] Wrong location%0D%0A[ ] Inappropriate content%0D%0A[ ] Duplicate event%0D%0A[ ] Other issue%0D%0A%0D%0ADetails:%0D%0A" class="external-form-link">\n                            📧 Send Report Email →\n                        </a>\n                        <p class="form-note">Opens your default email client with pre-filled information</p>\n                    </div>\n                    \n                    <div class="form-fallback">\n                        <h5>🔗 Open Report Form in New Tab</h5>\n                        <a href="${$().replace("embedded=true","usp=sf_link")}" target="_blank" class="external-form-link">\n                            📝 Open Report Form →\n                        </a>\n                        <p class="form-note">Opens the form in a new browser tab</p>\n                    </div>\n                </div>\n                \n                <button onclick="hideReportModal()" class="close-btn">✅ Got it, thanks!</button>\n            </div>\n        `)}function U(){const e=document.getElementById("report-modal");e&&e.classList.remove("show")}function q(){const e=document.getElementById("add-event-modal"),t=document.getElementById("add-event-modal-close");t&&t.addEventListener("click",H),e&&e.addEventListener("click",(t=>{t.target===e&&H()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e?.classList.contains("show")&&H()}))}function W(){const e=document.getElementById("report-modal"),t=document.getElementById("report-modal-close");t&&t.addEventListener("click",U),e&&e.addEventListener("click",(t=>{t.target===e&&U()})),document.addEventListener("keydown",(t=>{"Escape"===t.key&&e?.classList.contains("show")&&U()}))}window.hideDemoBanner=k,window.showWelcomeBanner=I,window.hideWelcomeBanner=L,window.bannerManager=E,window.showMarkerPopup=s,window.updateEventsDisplay=A,window.preserveEventsAfterResize=D,window.showReportModal=Z,window.hideReportModal=U,window.toggleMap=function(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(t.disabled)return;t.style.opacity="0.6",t.disabled=!0;let n={events:[],userLocationVisible:!1};if(window.captureVisibleEvents&&(n=window.captureVisibleEvents()),e.classList.toggle("expanded"),y=e.classList.contains("expanded"),window.isMapExpanded=y,localStorage.setItem("isMapExpanded",JSON.stringify(y)),t.textContent=y?"Expand calendar ▲▲▲":"Expand map ▼▼▼",f){const e=new Date;f.gotoDate(e),setTimeout((()=>{f.render()}),100)}setTimeout((()=>{o(),f&&f.updateSize(),t.style.opacity="1",t.disabled=!1,setTimeout((()=>{F(n)}),200)}),250)},document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const n=document.documentElement.classList.contains("dark-mode");document.body.classList.toggle("dark-mode",n);const o=JSON.parse(localStorage.getItem("activeFilters"));o&&(p=new Set(o)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",p.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",R),document.getElementById("toggle-map")?.addEventListener("click",toggleMap),document.getElementById("add-event-btn")?.addEventListener("click",N),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>B(e.dataset.type)))}));const{events:s,isDemo:d}=await w();if(u=s.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),d&&b(),v=await e(),t(n),a(),i(),q(),W(),T(),f=r(u),!f)throw new Error("Failed to initialize calendar");S(),C(),A(),setTimeout((()=>{window.setInitialOptimalZoom&&window.setInitialOptimalZoom()}),500),M(),x(),setTimeout((()=>{I()}),1e3)}catch(e){const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));