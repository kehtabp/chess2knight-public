import{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup}from"./map.js";import{initCalendar,updateEventDisplay,setCalendarToStartOfWeek,createPopupContent,getLocaleFirstDay}from"./calendar.js";let currentEvents=[],activeFilters=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["tournament","casual","workshop","club"]),map=null,calendar=null,isMapExpanded=JSON.parse(localStorage.getItem("isMapExpanded"))||!1;function toggleFilter(e){activeFilters.has(e)?activeFilters.delete(e):activeFilters.add(e),localStorage.setItem("activeFilters",JSON.stringify([...activeFilters])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",activeFilters.has(e.dataset.type))})),updateEventsDisplay()}function updateEventsDisplay(){const e=currentEvents.filter((e=>activeFilters.has(e.type)));console.log("Filtered events:",e),updateMarkers(e),updateEventDisplay(e)}function restoreMapState(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(isMapExpanded){if(e.classList.add("expanded"),t.textContent="Collapse map ▲▲▲",calendar){calendar.changeView("dayGridWeek");const e=new Date,t=new Date(e);t.setDate(e.getDate()+7),calendar.setOption("firstDay",e.getDay()),calendar.setOption("visibleRange",{start:e,end:t}),calendar.gotoDate(e)}setTimeout((()=>{invalidateMapSize()}),100)}else e.classList.remove("expanded"),t.textContent="Expand map ▼▼▼"}function toggleTheme(){const e=document.body.classList.toggle("dark-mode");localStorage.setItem("theme",e?"dark-mode":"light-mode"),updateMapStyle(e)}function toggleMap(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(t.style.opacity="0.6",t.disabled=!0,e.classList.toggle("expanded"),isMapExpanded=e.classList.contains("expanded"),localStorage.setItem("isMapExpanded",JSON.stringify(isMapExpanded)),isMapExpanded){if(t.textContent="Collapse map ▲▲▲",calendar){calendar.changeView("dayGridWeek");const e=new Date,t=new Date(e);t.setDate(e.getDate()+7),calendar.setOption("firstDay",e.getDay()),calendar.setOption("visibleRange",{start:e,end:t}),calendar.gotoDate(e)}}else t.textContent="Expand map ▼▼▼",calendar&&(calendar.changeView("dayGridMonth"),calendar.setOption("visibleRange",null),calendar.setOption("firstDay",getLocaleFirstDay()));invalidateMapSize(),setTimeout((()=>{invalidateMapSize(),calendar&&calendar.updateSize(),t.style.opacity="1",t.disabled=!1}),300)}window.showMarkerPopup=showMarkerPopup,document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const e=localStorage.getItem("theme");e&&document.body.classList.toggle("dark-mode","dark-mode"===e);const t=JSON.parse(localStorage.getItem("activeFilters"));t&&(activeFilters=new Set(t)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",activeFilters.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",toggleTheme),document.getElementById("toggle-map")?.addEventListener("click",toggleMap),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>toggleFilter(e.dataset.type)))}));const a=await fetch("assets/events.json");if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json();if(console.log("Loaded events:",n),currentEvents=n.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),console.log("Initializing map..."),map=initMap(),console.log("Initializing calendar..."),calendar=initCalendar(currentEvents),!calendar)throw new Error("Failed to initialize calendar");restoreMapState(),updateEventsDisplay()}catch(e){console.error("Error initializing app:",e);const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));