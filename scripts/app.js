import{initMap,updateMapStyle,updateMarkers,invalidateMapSize,showMarkerPopup,setupLocationBanner}from"./map.js";import{initCalendar,updateEventDisplay,setCalendarToStartOfWeek,createPopupContent,getLocaleFirstDay}from"./calendar.js";let currentEvents=[],activeFilters=new Set(JSON.parse(localStorage.getItem("activeFilters"))||["tournament","casual","workshop","club"]),map=null,calendar=null,isMapExpanded=JSON.parse(localStorage.getItem("isMapExpanded"))||!1,globalResizeTimeout=null;function toggleFilter(e){activeFilters.has(e)?activeFilters.delete(e):activeFilters.add(e),localStorage.setItem("activeFilters",JSON.stringify([...activeFilters])),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",activeFilters.has(e.dataset.type))})),updateEventsDisplay()}function updateEventsDisplay(){const e=currentEvents.filter((e=>activeFilters.has(e.type)));console.log("Filtered events:",e),updateMarkers(e),updateEventDisplay(e)}function restoreMapState(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(isMapExpanded){if(e.classList.add("expanded"),t.textContent="Expand calendar ▲▲▲",calendar){const e=new Date;calendar.changeView("dayGridWeek"),calendar.setOption("firstDay",e.getDay()),calendar.gotoDate(e)}setTimeout((()=>{invalidateMapSize()}),100)}else e.classList.remove("expanded"),t.textContent="Expand map ▼▼▼"}function toggleTheme(){const e=document.body.classList.toggle("dark-mode");document.documentElement.classList.toggle("dark-mode",e),localStorage.setItem("theme",e?"dark-mode":"light-mode"),updateMapStyle(e)}function toggleMap(){const e=document.getElementById("map-container"),t=document.getElementById("toggle-map");if(!t.disabled){if(t.style.opacity="0.6",t.disabled=!0,e.classList.toggle("expanded"),isMapExpanded=e.classList.contains("expanded"),localStorage.setItem("isMapExpanded",JSON.stringify(isMapExpanded)),t.textContent=isMapExpanded?"Expand calendar ▲▲▲":"Expand map ▼▼▼",calendar){const e=window.innerWidth<=768;if(isMapExpanded){if(e)calendar.changeView("listWeek");else{const e=new Date;calendar.changeView("dayGridWeek"),calendar.setOption("firstDay",e.getDay())}calendar.gotoDate(new Date)}else e?calendar.changeView("listWeek"):(calendar.changeView("dayGridMonth"),calendar.setOption("firstDay",getLocaleFirstDay())),calendar.gotoDate(new Date)}setTimeout((()=>{invalidateMapSize(),calendar&&calendar.updateSize(),t.style.opacity="1",t.disabled=!1}),250)}}function setupGlobalResizeHandler(){window.addEventListener("resize",(()=>{globalResizeTimeout&&clearTimeout(globalResizeTimeout),globalResizeTimeout=setTimeout((()=>{map&&invalidateMapSize(),calendar&&calendar.updateSize()}),200)}))}window.showMarkerPopup=showMarkerPopup,document.addEventListener("DOMContentLoaded",(async function(){try{if(void 0===window.FullCalendar)throw new Error("FullCalendar is not loaded. Please check your internet connection and try again.");const e=document.documentElement.classList.contains("dark-mode");document.body.classList.toggle("dark-mode",e);const t=JSON.parse(localStorage.getItem("activeFilters"));t&&(activeFilters=new Set(t)),document.querySelectorAll(".filter-btn").forEach((e=>{e.classList.toggle("active",activeFilters.has(e.dataset.type))})),document.getElementById("theme-toggle")?.addEventListener("click",toggleTheme),document.getElementById("toggle-map")?.addEventListener("click",toggleMap),document.querySelectorAll(".filter-btn").forEach((e=>{e.addEventListener("click",(()=>toggleFilter(e.dataset.type)))}));const a=await fetch("assets/events.json");if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const n=await a.json();if(console.log("Loaded events:",n),currentEvents=n.map(((e,t)=>({...e,id:e.id||`event-${t}`}))),console.log("Initializing map..."),map=await initMap(),updateMapStyle(e),setupLocationBanner(),console.log("Initializing calendar..."),calendar=initCalendar(currentEvents),!calendar)throw new Error("Failed to initialize calendar");restoreMapState(),updateEventsDisplay(),setupGlobalResizeHandler()}catch(e){console.error("Error initializing app:",e);const t=document.getElementById("calendar");t&&(t.innerHTML=`<div class="error-message">Error: ${e.message}</div>`)}}));